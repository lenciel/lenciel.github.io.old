
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>@Lenciel</title>
  <meta name="author" content="Lenciel Li">

  
  <meta name="description" content="概念：设备像素和CSS像素 首先要明白CSS像素和设备像素之间的区别。 设备像素是定义了我们使用的设备的分辨率，一般来说可以通过screen.width/height来得到。 如果我们在浏览器里面创建一个width:128px的元素，而我们的屏幕是1024px宽，那么在浏览器最大化的时候， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://lenciel.cn/blog/page/12/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/github/lenciel" rel="alternate" title="@Lenciel" type="application/atom+xml">
  <!-- Facebook Open Graph
     Facebook Debugger: https://developers.facebook.com/tools/debug -->

<meta property="og:type" content="article" />
<meta property="og:url" content="http://lenciel.cn/blog/page/12/" />
<meta property="og:description" content="概念：设备像素和CSS像素 首先要明白CSS像素和设备像素之间的区别。 设备像素是定义了我们使用的设备的分辨率，一般来说可以通过screen.width/height来得到。 如果我们在浏览器里面创建一个width:128px的元素，而我们的屏幕是1024px宽，那么在浏览器最大化的时候， &hellip;" />

<meta property="og:site_name" content="http://lenciel.cn" />
<meta property="article:author" content="https://plus.google.com/114787528537231301324">



<meta itemprop="description" content="概念：设备像素和CSS像素 首先要明白CSS像素和设备像素之间的区别。 设备像素是定义了我们使用的设备的分辨率，一般来说可以通过screen.width/height来得到。 如果我们在浏览器里面创建一个width:128px的元素，而我们的屏幕是1024px宽，那么在浏览器最大化的时候， &hellip;" />

<!-- Combine multiple fonts into one request -->
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic|Patua+One|Yanone+Kaffeesatz" rel="stylesheet" type="text/css">
<!-- jQuery -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>

  <script>
  !function(g,s,q,r,d){r=g[r]=g[r]||function(){(r.q=r.q||[]).push(
  arguments)};d=s.createElement(q);q=s.getElementsByTagName(q)[0];
  d.src='//d1l6p2sc9645hc.cloudfront.net/tracker.js';q.parentNode.
  insertBefore(d,q)}(window,document,'script','_gs');

  _gs('GSN-360316-J');
</script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-175991-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">@Lenciel</a></h1>
  
    <h2>Thoughts and Rants.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/github/lenciel" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:lenciel.cn" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/"><i class="icon-home"></i>Home</a></li>
  <li><a href="/blog/archives"><i class="icon-book-alt"></i>Archives</a><span class="divider"></span></li>
  <li><a href="/about"><i class="icon-user"></i>About</a><span class="divider"></span></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2012/08/how-to-define-viewport-for-mobile/">How to Define Viewport for Mobile</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-09T22:39:00+08:00" pubdate data-updated="true">Aug 9<span>th</span>, 2012</time>
        
         | <a href="/2012/08/how-to-define-viewport-for-mobile/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h4 id="css"><strong>概念：设备像素和CSS像素</strong></h4>

<p>首先要明白CSS像素和设备像素之间的区别。</p>

<p>设备像素是定义了我们使用的设备的分辨率，一般来说可以通过<code>screen.width/height</code>来得到。</p>

<p>如果我们在浏览器里面创建一个<code>width:128px</code>的元素，而我们的屏幕是1024px宽，那么在浏览器最大化的时候，浏览器的宽度应该是这个元素的八倍（大概八倍，暂时忽略那些tricky的bits）。</p>

<p>如果用户使用滚轮放大或者缩小页面(Zooming)，那么这个关系就会变化。一般来说，现在的浏览器对Zomming的实现都是通过伸缩像素，也就是当用户Zoom到200%的时候，你的<code>128px</code>宽的元素宽度并不会变成<code>256px</code>，而是每个像素的宽度翻倍了：这个元素还是<code>128px</code>的宽度，但是占据了256个设备像素。</p>

<p>也就是说，zoom到200%其实会让一个CSS像素从一个设备像素变成四个设备像素的大小（长宽各翻一倍，面积就变成了4倍）。</p>

<p>         原始(zoom 100%)                 开始放大(zoom in)              开始缩小(zoom out)</p>

<p><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="csspixels_100" border="0" alt="csspixels_100" src="/downloads/images/2012_08/csspixels_100.gif" width="208" height="208" />  <img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="csspixels_in" border="0" alt="csspixels_in" src="/downloads/images/2012_08/csspixels_in.gif" width="208" height="208" />  <img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="csspixels_out" border="0" alt="csspixels_out" src="/downloads/images/2012_08/csspixels_out.gif" width="208" height="208" /> </p>

<p>从这里可以看出，我们在使用css像素值在css文件里面定义宽度时，不需要考虑设备像素，因为在zoom的时候css像素值是不变的。用户在缩放的时候，浏览器负责放大缩小那些元素，但是整个layout是不变的。 </p>

<h4 id="section"><strong>屏幕大小</strong></h4>

<p><code>screen.width</code>和<code>screen.height</code>可以获取用户屏幕的尺寸。获得的尺寸值的单位是设备像素，换句话说，它们是不变的(可以看成是显示器的硬件指标，而不随浏览器窗口缩放而变化)。 </p>

<p><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="desktop_screen" border="0" alt="desktop_screen" src="/downloads/images/2012_08/desktop_screen.jpg" width="604" height="379" /> </p>

<p>一般来说，用户的屏幕大小对我们是无用的信息。很少有人使用它（除开统计站点访问信息时）。 </p>

<h4 id="section-1"><strong>窗口大小</strong></h4>

<h4 id="section-2"></h4>

<p>窗口大小表示了当前你的CSS layout可以占用的空间大小。可以通过<code>window.innerWidth</code>和<code>window.innerHeight</code>来获取它们。</p>

<p><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="desktop_inner" border="0" alt="desktop_inner" src="/downloads/images/2012_08/desktop_inner.jpg" width="604" height="379" /> </p>

<p>很显然，窗口大小的单位是CSS像素值。当用户用滚轮放大缩小自己的窗口大小的时候，<code>window.innerWidth/Height</code>会相应的变化，这样你就知道自己的layout有多大空间可用了。</p>

<p>注意：Opera是一个例外，它的<code>window.innerWidth/Height</code>不会因为缩放变化，而是取的设备像素值。这点对于桌面操作系统上的应用很讨厌，但是就像后面会说到的，对于手机来说很关键。 </p>

<h4 id="scrolling-offset"><strong>Scrolling offset</strong></h4>

<p><code>window.pageXOffset/pageYOffset</code>代表了当前的document在横向和纵向上的偏移量。这样你就知道用户scroll了多少内容。</p>

<p><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="desktop_page" border="0" alt="desktop_page" src="/downloads/images/2012_08/desktop_page.jpg" width="604" height="519" /> </p>

<p>这些值也是CSS像素，理论上，当用户做缩放的时候，<code>window.pageXOffset/pageYOffset</code>也会变化。但是实际上，浏览器一般会在用户缩放的时候保证置顶的元素不变，所以在缩放的时候，一般来说这两个值基本是不变的。 </p>

<h4 id="viewport"><strong>概念：Viewport</strong></h4>

<p><code>Viewport</code>的主要作用是限定<code>&lt;html&gt;</code>元素，也就是整个页面的最高级元素的大小。这样说比较含糊，我们来看一个详尽的例子：假设你有一个页面，侧栏的宽度是10%。在你缩放浏览器窗口大小的时候，这个侧边栏也会自动缩放。这是如果实现的？</p>

<p>技术上讲，按照设置，侧边栏会自动占据自己的父元素（这里我们可以假设是<code>&lt;body&gt;</code>）宽度的10%。那么<code>&lt;body&gt;</code>的宽度呢？又会取它的父元素<code>&lt;html&gt;</code>的宽度的100%——因为理论上所有的HTML的block-level元素都会自动取父元素宽度的100%（有些例外情况，我们这里忽略它们）。</p>

<p>那么<code>&lt;html&gt;</code>的宽度是怎么来的呢？所有的网页开发者都默认它就是浏览器的宽度。的确如此——在桌面浏览器上就是这样。实际上，就像我们已经提到过的，&lt;html&gt;的宽度是viewport限定的。在桌面上它就是整个浏览器窗口的宽度，而在手机上则要复杂得多。 </p>

<h4 id="section-3"><strong>手机浏览器</strong></h4>

<p>手机一个显而易见的特点就是屏幕小。如果我们原封不动的使用为桌面版浏览器开发的网站的文件，就会发现它们在手机浏览器上面目全非。但是大多数网站开发者是没有精力给手机用户专门维护另外一个网站的。因此手机浏览器制造商尽可能的通过技术手段让网站在手机上和在桌面浏览器里看起来“差不多”。 </p>

<h4 id="viewports"><strong>两个viewports</strong></h4>

<p>既然手机浏览器的viewport比较小，没法呈现所有css定义的元素，那么解决这个问题的办法就很明显了：扩大手机上的viewport。最终，手机浏览器通过<code>visual viewport</code>和<code>layout viewport</code>的合作来解决问题。</p>

<p>George在Stack Overflow上<a href="http://stackoverflow.com/questions/6333927/difference-between-visual-viewport-and-layout-viewport" target="_blank">解释</a>说：</p>

<p>layout viewport就像一个不改变大小和形状的大的图片。想象一下你透过一个小窗口去看这个大的图片，因为窗框的遮挡，你只能看到大图片的一部分。这部分就是visual viewport。你可以改变自己和这个窗口的位置（其实就是缩放），你也可以把窗口横放或者竖放，但是大图片本身（layout viewport）是不会改变的。</p>

<p><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="mobile_visualviewport" border="0" alt="mobile_visualviewport" src="/downloads/images/2012_08/mobile_visualviewport.jpg" width="404" height="549" /></p>

<p>要注意，CSS layout，特别是用百分比定义的layout，都是用layout viewport来算的，一般来说比visual viewport要宽很多。</p>

<p>因此，起始阶段&lt;html&gt;会占据整个layout viewport的宽度，你用CSS定义的元素的尺寸会比手机屏幕的尺寸要宽，这主要是要模拟网站在手机浏览器上的表现。</p>

<p>那么layout viewport究竟有多宽？这个要看具体的手机浏览器。Safari的iPhone版为980px，Opera是850px，Android的Webkit是800px，而IE是974px。还有一些其他的浏览器除开特别的宽度之外有特别的行为，比如Symbian上的Webkit会尽量保持layout viewport和visual viewport相同。当layout viewport超过了850px的时候，两者才会变得不同。 </p>

<h4 id="section-4"><strong>缩放</strong></h4>

<p>很明显，visual和layout两种viewport都使用了CSS像素，但是layout viewport是不会因为缩放操作变化的，而visual viewport会。很多的移动设备上的浏览器，在默认情况下都是以完全zoom-out的尺寸来显示页面的——结合前面的对两种viewport的简介，你可以认为这种时候你是把头伸到窗口(visual viewport)外在看窗外那副大图片(layout viewport)，这种情况下两个viewport也是相等的（没有被窗框遮住的部分）。</p>

<p>因此，layout viewport的宽和高等于在完全zoom-out的情况下screen上最大可显示的CSS像素值大小。因此在随后用户如果zoom-in了这个值是不会变化的。</p>

<p>下面的图表示了这个变化：在刚开始打开一个页面的时候，处于完全zoom-out的状态，layout viewport的值等于visual viewport的值。随后，当用户zoom-in（放大页面）时，每个CSS像素变成数倍于设备像素，而整个layout viewport的值不变（这样才保证你为页面定义的CSS长宽有意义），于是layout viewport的物理范围扩大了不少。</p>

<p><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="mobile_viewportzoomedout" border="0" alt="mobile_viewportzoomedout" src="/downloads/images/2012_08/mobile_viewportzoomedout.jpg" width="240" height="418" />                              <img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="mobile_layoutviewport" border="0" alt="mobile_layoutviewport" src="/downloads/images/2012_08/mobile_layoutviewport.jpg" width="304" height="413" /></p>

<p>另外要注意的就是layout viewport的宽度是保持不变的。也就是说在默认情况下，竖屏转横屏的时候，虽然visual viewport变化了，但是浏览器会自动的zoom-in一些来使得layout viewport和visual viewport仍然相等。这种情况下，layout viewport的高度会变小，但是，对于web开发者而言，最重要的是宽度能保持不变。</p>

<p><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="mobile_viewportzoomedout" border="0" alt="mobile_viewportzoomedout" src="/downloads/images/2012_08/mobile_viewportzoomedout.jpg" width="240" height="418" />            <img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="mobile_layoutviewport_la" border="0" alt="mobile_layoutviewport_la" src="/downloads/images/2012_08/mobile_layoutviewport_la.jpg" width="362" height="298" />  </p>

<h4 id="layout-viewport"><strong>测量layout viewport</strong></h4>

<p><code>document.documentElement.clientWidth/Height</code>得到的是layout viewport的数值。并且，如前所述，横竖屏转换时，只会影响Height不会影响Width取值。</p>

<blockquote>
  <p><strong>document.documentElement.clientWidht/Height</strong>：</p>

  <ul>
    <li>Layout viewport </li>
    <li>使用CSS像素值为单位 </li>
    <li>支持Opera、iPhone、Android、Symbian、Bolt、MicroB、Skyfire和Obigo </li>
    <li>有一些问题： </li>
  </ul>

  <ol>
    <li>
      <div>
  Samsung的Webkit的viewport只有当显式指定了<meta viewport="" />的时候才有效，否则返回的是<html>元素的长宽


</html></div>
    </li>
    <li>
      <div>
  Firefox返回的是以设备像素值为单位的结果
</div>
    </li>
    <li>
      <div>
  IE返回1024&#215;768，正确的信息要通过<code>document.body.clientWidth/Height</code>获取
</div>
    </li>
  </ol>
</blockquote>

<h4 id="visual-viewport"><strong>测量visual viewport</strong></h4>

<p><code>window.innerHeight/Width</code>返回的是visual viewport。很显然，当用户缩放的时候，这两个值会变化，因为有更多或者更少的CSS像素适配到屏幕可见的部分中。</p>

<blockquote>
  <p><strong>window.innerHeight/Width</strong>：</p>

  <ul>
    <li>visual viewport </li>
    <li>使用CSS像素值为单位 </li>
    <li>支持iPhone、Symbian、BlackBerry </li>
    <li>有一些问题： </li>
  </ul>

  <ol>
    <li>
      <div>
  Samsung的Webkit返回的是layout viewport的取值只有当显式指定了<meta viewport="" />的时候才有效，否则返回的是<html>元素的长宽


</html></div>
    </li>
    <li>
      <div>
  Firefox和Opera返回的是以设备像素值为单位的结果
</div>
    </li>
    <li>
      <div>
  IE不支持，正确的信息要通过<code>document.documentElement.offsetWidth/Height</code>获取
</div>
    </li>
    <li>
      <div>
  其他的如Iris、Skyfire或者Obigo是有返回值到乱来的
</div>
    </li>
  </ol>
</blockquote>

<h4 id="section-5"><strong>手机屏幕大小</strong></h4>

<p>前面提到过，在桌面系统，screen.width/hieght返回屏幕的大小，但是和桌面系统一样，开发者都不关心这个值：因为物理上屏幕多大并不重要，我们更关心多少个CSS像素能弄进这个屏幕。 </p>

<h4 id="html"><strong>&lt;html&gt;元素</strong></h4>

<p>通过<code>document.documentElement.offsetWidth/Height</code>可以获取<code>&lt;html&gt;</code>元素的CSS像素单位的尺寸。 </p>

<h4 id="section-6"><strong>缩放比例</strong></h4>

<p>当screen.width和window.innerWidth在你工作的平台都得到了正确实现的时候，两者相除就可以得到缩放的比例大小。 </p>

<h4 id="media-query"><strong>Media query</strong></h4>

<p>Media query的思想就是定义只在页面大于，等于或者是小于一定尺寸的时候，才被执行的CSS规则。比如：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="css"><span class="line"><span class="nt">div</span><span class="nc">.sidebar</span> <span class="p">{</span>
</span><span class="line">    <span class="k">width</span><span class="o">:</span> <span class="m">300px</span><span class="p">;</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">@media</span> <span class="nt">all</span> <span class="nt">and</span> <span class="o">(</span><span class="nt">max-width</span><span class="o">:</span> <span class="nt">400px</span><span class="o">)</span> <span class="p">{</span>
</span><span class="line">    <span class="o">//</span> <span class="nt">styles</span> <span class="nt">assigned</span> <span class="nt">when</span> <span class="nt">width</span> <span class="nt">is</span> <span class="nt">smaller</span> <span class="nt">than</span> <span class="nt">400px</span><span class="o">;</span>
</span><span class="line">    <span class="nt">div</span><span class="nc">.sidebar</span> <span class="p">{</span>
</span><span class="line">        <span class="k">width</span><span class="o">:</span> <span class="m">100px</span><span class="p">;</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>规则指定了当宽度小于400px的时候sidebar是100px，其余时候是300px。</p>

<p>需要注意的是在定义media query的时候可以用两套长宽：css里的width/height表示的是documentElement. clientWidth/Height取值，也就是viewport，单位是css像素。css里的device-width/height表示的是screen.width/height，单位是物理像素。</p>

<p>那么使用哪种值来定义media query甚至用不用它都是让人疑惑的问题。比如你用device-width的话 ，其实效果和使用<meta viewport="" />来定义是类似的。但是用width，仅仅是一个模糊的像素宽度，更加缺乏在各种设备上具体效果的准确预期。目前来看，用media query应该能比较正确的区分运行环境是桌面，手机还是平板，但是并不太能细致到是那款平板或者是什么手机。 </p>

<h4 id="meta-viewport"><strong>Meta viewport</strong></h4>

<p>终于可以来讨论<meta name="viewport" />了。这个最早是Apple的一个扩展，但是现在已经被各种浏览器抄去了。它主要的作用是用来重定义layout viewport的大小。</p>

<p>我们通过实例来解释：假设你开发了一个网站，没有写css，因此所有的元素没有width属性。打开页面的时候，它们会默认zoom-out到最大，看起来像这样：</p>

<p><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="mq_none" border="0" alt="mq_none" src="/downloads/images/2012_08/mq_none.jpg" width="258" height="455" /></p>

<p>用户肯定会zoom-in，这时因为很多浏览器会保持每个元素的宽度仍然是100%的layout viewport，因此，很多文字就撑到visual viewport外面去了变得不可见了(Android原生的Webkit在这种情况下会自动调整text-containing元素的宽度来适配屏幕宽度）。</p>

<p><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="mq_none_zoomed" border="0" alt="mq_none_zoomed" src="/downloads/images/2012_08/mq_none_zoomed.jpg" width="336" height="406" /> </p>

<p>为了避免这种情况，你可能会加上html {width:320px}的css规则。这样&lt;html&gt;的宽度，也就是大多数未定义宽度的元素继承到的宽度，是320px。这样的规则可以解决用户zoom-in放大页面之后溢出的问题，但是当用户刚打开页面的时候，大概又会看的下图的效果(因为300个CSS像素值在完全zoom-out的情况下是很窄的）：</p>

<p><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="mq_html300" border="0" alt="mq_html300" src="/downloads/images/2012_08/mq_html300.jpg" width="254" height="445" /></p>

<p>为了解决这种初始和用户缩放之后的不和谐，Apple定义了一个新的meta值。你可以用</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="css"><span class="line"><span class="o">&lt;</span><span class="nt">meta</span> <span class="nt">name</span><span class="o">=</span><span class="s2">&quot;viewport&quot;</span> <span class="nt">content</span><span class="o">=</span><span class="s2">&quot;width=320&quot;</span><span class="o">/&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>来确定<code>layout viewport</code>的宽度。这样在初始的时候，整个页面看起来仍然是非常正确的：</p>

<p><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="mq_yes" border="0" alt="mq_yes" src="/downloads/images/2012_08/mq_yes.jpg" width="254" height="448" /></p>

<p>meta中定义的layout viewport宽度甚至可以是device-width，也就是以设备像素值标定的<code>screen.width</code>取值。但是这里有一个陷阱，就是有时候正式的<code>screen.width</code>的取值并不是真的有实际意义，因为像素值可能太高。比如Nexus One的屏幕宽度是480px，但是Google的工程师觉得用<code>device-width</code>来定义<code>viewport</code>就让<code>layout viewport</code>取值480px太宽了，于是它们让device-width的返回值打了个2/3的折扣，只有320px，和iphone一致。这样一来，<code>device-width</code>的取值又有点儿CSS像素值的意思了。这种resolution标称的像素值和<code>device-width</code>的返回值之间的关系被称为<code>CSS pixel density</code>。</p>

<table border="3" cellspacing="0" cellpadding="2" width="772">
  <tr>
    <td valign="top" width="158">
      <strong>Device</strong>
    </td>
    
    <td valign="top" width="170">
      <strong>resolution (px)</strong>
    </td>
    
    <td valign="top" width="442">
      <strong>device-width/ device-height (px)</strong>
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="158">
      iPhone
    </td>
    
    <td valign="top" width="170">
      320 x 480
    </td>
    
    <td valign="top" width="442">
      320 x 480, portrait/landscape mode
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="158">
      iPhone 4
    </td>
    
    <td valign="top" width="170">
      640 x 960
    </td>
    
    <td valign="top" width="442">
      <p>
        320 x 480, in both portrait and landscape mode
      
      
      <p>
        CSS pixel density&#160; = 2
      
    
  
  
  <tr>
    <td valign="top" width="158">
      iPad 1 and 2
    </td>
    
    <td valign="top" width="170">
      768 x 1024
    </td>
    
    <td valign="top" width="442">
      768 x 1024, portrait/landscape mode
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="158">
      new iPad
    </td>
    
    <td valign="top" width="170">
      1536 x 2048
    </td>
    
    <td valign="top" width="442">
      <p>
        768 x 1024, portrait/landscape mode
      
      
      <p>
        CSS pixel density = 2
      
    
  
  
  <tr>
    <td valign="top" width="158">
      Samsung Galaxy S I and II
    </td>
    
    <td valign="top" width="170">
      480 x 800
    </td>
    
    <td valign="top" width="442">
      <p>
        320 x 533, portrait mode
      
      
      <p>
        CSS pixel density = 1.5
      
    
  
  
  <tr>
    <td valign="top" width="158">
      Samsung Galaxy S III
    </td>
    
    <td valign="top" width="170">
      720 x 1280
    </td>
    
    <td valign="top" width="442">
      360? x 640?, portrait mode
    </td>
  </tr>
  
  <tr>
    <td valign="top" width="158">
      HTC Evo 3D
    </td>
    
    <td valign="top" width="170">
      540 x 960
    </td>
    
    <td valign="top" width="442">
      <p>
        360 x 640, portrait mode
      
      
      <p>
        CSS pixel density = 1.5
      
    
  
  
  <tr>
    <td valign="top" width="158">
      Amazon Kindle Fire
    </td>
    
    <td valign="top" width="170">
      1024 x 600
    </td>
    
    <td valign="top" width="442">
      1024 x 600, landscape mode
    </td>
  </tr>


</p></p></td></tr></p></p></td></tr></p></p></td></tr></p></p></td></tr></table>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2012/05/get-start-with-python/">Getting Start With Python</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-28T22:15:00+08:00" pubdate data-updated="true">May 28<span>th</span>, 2012</time>
        
         | <a href="/2012/05/get-start-with-python/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>刚刚开始使用Python开发的新手，遇到的第一个瓶颈（常常）就是缺乏对整个Python生态系统的理解。大家总是在网上搜索完成这件事或者那件事的“标准做法”，就像我们使用其他编程语言的时候常常需要掌握的一样。</p>

<p>在和几个朋友开始iDVR的开发的时候，我们在内部Wiki上维护过一个Python中常见问题列表。我们的目标是随着项目的不断进步，这个内部的wiki能够变成一个豪华的Q&amp;A索引，但是事实证明项目一忙起来就没有人去写Wiki了。</p>

<p>最近陆续有朋友问一些Python相关的问题，想想其实要用三言两语说清楚并不容易，就决定在那份wiki的基础上自己写一个版本，给那些刚开始使用Python（从来没有编过程的读起来可能没啥帮助）的同学。</p>

<h4 id="warning"><strong>Warning</strong></h4>

<p>Python编程是个大话题，不是这里讨论的内容。如果你没有太多编程经验，应该先去看一点儿Python的<a href="http://learnpythonthehardway.org/" target="_blank">入门书籍</a>。</p>

<p>另外，这片文章是基于Windows（最好是Win7 32bit）操作系统。潮人请不要问为啥不是Mac或者Linux，因为本座主要用的机器（包括码这篇Blog）都是用Win7 32bit。不过除开环境搭建，这里提到的大部分概念对其他系统都是适用的。</p>

<p>如果你有环境搭建上的问题，最靠谱的提问的地方不是CSDN或者百度知道，是<a href="http://stackoverflow.com/" target="_blank">Stack Overflow</a>。</p>

<h2 id="section">版本选择</h2>

<p>本座在某软件公司面试的时候别人看到简历上有Python就问，Python3用过吗？本座老实回答没有，结果面试官就停下他正在笔记本上google的微操，在脸上流露出一丝嘲讽…</p>

<p>不过，除了Python这门语言本身的开发者，大多数像本座这种使用Python的人，都没有紧跟Python3的步伐。Python3（或者叫Py3K）是一个大多数我熟悉的包，框架和工具都还没有完备支持的版本（在未来的数年本座也看不到希望）。如果不是想研究Python3的新特性或者具体实现，个人觉得初学的开发者使用2.7.x是最安全的版本（本座还在用进M公司就装好的2.6版本）。</p>

<p>如果你比较熟悉Python但是不确定该不该升级到Python3，不妨先去观赏一下<a href="http://python3wos.appspot.com/">Python 3 Wall of Shame</a> (墙外，你们懂的)。</p>

<h2 id="vm">VM选择</h2>

<p>Python是<a href="http://zh.wikipedia.org/zh-hk/%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80" target="_blank">脚本语言</a>，因此需要VM。CPython是最主流的选择，也被当成其他VM实现时的参考。其他常见的还有用Python实现的<a href="http://pypy.org/">PyPy</a>，用Java实现的<a href="http://www.jython.org/">Jython</a> 以及用Microsoft .Net CLR实现的<a href="http://ironpython.net/">IronPython</a>。如果你不是非常非常确定你自己要选用别的，就安装CPython吧。</p>

<p>换句话说，前面这堆关于VM和版本选择的建议在你看来不知所云，你需要的就是<a href="http://www.python.org/getit/" target="_blank">CPython 2.7.x版本</a>。</p>

<h2 id="python">Python安装</h2>

<p>下载之后的.exe安装文件安装的时候有一个地方需要注意：如果你是在Vista/Win7这样的C盘权限控制异常严格的操作系统，最好用右键“Run as administrator”。这点也适用于你下载到的被其他人编译成exe发布的Python package。嗯，什么是package？</p>

<h2 id="package">理解Package</h2>

<p>Python没有一个内置的package管理体系。实际上Python下面一个package是什么也是一个很“不具体”的概念。就像前面提到的，Python下面的代码是以module为单位存在的。每个module既可以是一个只有一个函数的文件，也可以是一个包含了一个或者多个子module的目录。而module和package之间的区别是非常模糊的，每个module都可以被认为是一个package。</p>

<p>和所有的编程环境一样，在Python下面有一些函数和类是全局可见的（<code>str</code>，<code>len</code>，<code>Exception</code>等等），而另外一些需要通过<code>import</code>语句导入，比如：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">&gt;&gt;&gt;</span><span class="kn">import</span> <span class="nn">os</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span><span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">basename</span><span class="p">,</span> <span class="n">dirname</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>这里<code>import</code>被调用的时候，Python是从哪里把这些module导入的呢？其实，在你安装Python的时候，module的导入路径已经被自动设置过了。这个过程的具体实现是跟你运行的平台相关的，你可以通过<code>sys.path</code>来查看被设置的路径究竟是什么。比如本座的是：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="o">[</span><span class="s1">&#39;&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib\\site-packages\\demjson-1.4-py2.6.egg&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib\\site-packages\\anyjson-0.2.5-py2.6.egg&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib\\site-packages\\pmw-1.3.2-py2.6.egg&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib\\site-packages\\paramiko-1.7.6-py2.6.egg&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib\\site-packages\\treewidgets-1.0a1-py2.6.egg&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib\\site-packages\\mechanize-0.2.3-py2.6.egg&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib\\site-packages\\pylint-0.22.0-py2.6.egg&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib\\site-packages\\logilab_astng-0.21.0-py2.6.egg&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib\\site-packages\\logilab_common-0.53.0-py2.6.egg&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib\\site-packages\\unittest2-0.5.1-py2.6.egg&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib\\site-packages\\virtualenv-1.5.1-py2.6.egg&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib\\site-packages\\django_staticfiles-0.3.2-py2.6.egg&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib\\site-packages\\django_attachments-0.3dev-py2.6.egg&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib\\site-packages\\django_ajax_validation-0.1.4-py2.6.egg&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib\\site-packages\\django_email_confirmation-0.2.dev4-py2.6.egg&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib\\site-packages\\distribute-0.6.10-py2.6.egg&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib\\site-packages\\django_timezones-0.2.dev1-py2.6.egg&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib\\site-packages\\django-1.3-py2.6.egg&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\ \Python26\\lib\\site-packages\\rbtools-0.3.2-py2.6.egg&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib\\site-packages\\django_debug_toolbar-0.8.4-py2.6.egg&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib\\site-packages\\suds-0.4-py2.6.egg&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Windows\\system32\\python26.zip&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\DLLs&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib\\plat-win&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib\\lib-tk&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib\\site-packages&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib\\site-packages\\PIL&#39;</span>,
</span><span class="line"><span class="s1">&#39;C:\\Python26\\lib\\site-packages\\wx-2.8-msw-unicode&#39;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Python在导入的module的时候，是按照这个列表“自顶向下，见好就收”的方式运作的。也就是说如果你正好机器上有两个路径下面安装了同样名称的module，先被搜索到的那个就会被导入。有的时候，你确信自己受到了这种机制的干扰，也可以通过下面的办法来hack回来：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(,</span> <span class="s">&#39;path</span><span class="se">\\</span><span class="s">to</span><span class="se">\\</span><span class="s">your</span><span class="se">\\</span><span class="s">packages&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>进行一段时间的Python开发过后你总是会有很多的包，于是这个办法你会觉得非常的方便。但是，请结合后面的内容默默记住，不到万不得已，不要这样hack。</p>

<h5 id="the-pythonpath"><strong>The PYTHONPATH</strong></h5>

<p><code>PYTHONPATH</code>是一个环境变量（可以win+break到高级设置里面去设置），可以简单的理解它就是Windows下面的<code>PATH</code>变量，不过只是对Python可见而已。在很多Python的教程里面，会说所有你想要让Python搜索module的路径，都应该加到这个变量对应的列表里面。</p>

<p>其实前面提到过，在Python安装的时候搜索路径已经被自动设置过一次。所以<code>PYTHONPATH</code>这个变量并不是必须加的。而且，作为开发环境满坑满谷的程序员，我们都喜欢把Path里面搞得干干净净的（比如本座干活都习惯在bat里面先设置相关的路径再起相应的Eclipse）。这种一启动就load一堆的办法，自己喜欢也可以用，但是更推荐后面会说的<code>virtualenv</code>。</p>

<h5 id="package-1"><strong>第三方package</strong></h5>

<p>首先，入门之后要开始正经干活，你总是需要安装一些第三方的Package。安装的办法有：</p>

<ol>
  <li>下载别人编译好的Windows的版本exe</li>
  <li>使用<code>pip</code>或者<code>easy_install</code></li>
  <li>自己从代码安装</li>
</ol>

<p>三种办法干的事情都是类似的：下载package的依赖包，编译（需要的话）和拷贝目标文件到一个默认的第三方Package路径。那么，哪里去找安装需要的文件呢？一般来说：</p>

<ol>
  <li>Google</li>
  <li><a href="http://pypi.python.org/pypi">Python Package Index(or PyPI)</a></li>
  <li>各种开源的代码库(<a href="https://launchpad.net/">Launchpad</a>/<a href="http://github.com/">GitHub</a>/<a href="https://bitbucket.org/">BitBucket</a>）</li>
</ol>

<h5 id="exe"><strong>安装别人编译好的exe</strong></h5>

<p>注意下载的时候看清别人编译是在32还是64bit的Windows，Python的版本和你用的一致不一致。运行exe的时候注意右键Run as Administrator。就这么简单。</p>

<h5 id="pip"><strong>使用pip</strong></h5>

<p><code>easy_install</code>已经慢慢失宠了，主要介绍一下它的替代品：<code>pip</code>。</p>

<p><code>pip</code>是用来安装和管理Python Package的工具。它不是随Python默认安装的，因此需要额外安装。安装完毕之后我们就可以在命令行里面调用它来管理package了。比如你要安装<code>pygame</code>这个package，只需要：</p>

<div class="wp_syntax">
  <div class="code">
    <pre class="python" style="font-family:monospace;">pip install pygame</pre>
  </div>
</div>

<p>而如果你想删除它的话，则运行：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">pip uninstall pygame
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><code>pip</code>默认会按照你指定的名字，搜索和安装最新的stable版本的包。但我们常常需要安装某个特定版本的包，这个时候需要你在命令行里面指定：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">pip install <span class="nv">pygame</span><span class="o">==</span>version_number
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>如果你安装的版本不对，可以通过<code>upgrade</code>命令升级/降级到指定版本：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">pip install <span class="nv">pygame</span><span class="o">==</span>version_number –upgrade
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>由于Python高度依赖开源团体，很多最新的package都没有在PyPI上面，我们常常需要从代码库直接安装package。在<code>pip</code>下面可以直接</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">$ </span>pip install git+http://somedomain.com/path/to/git-repo#egg<span class="o">=</span>packagename
</span><span class="line"><span class="nv">$ </span>pip install hg+http://somedomain.com/path/to/hg-repo#egg<span class="o">=</span>packagename
</span><span class="line"><span class="nv">$ </span>pip install svn+http://somedomain.com/path/to/svn-repo#egg<span class="o">=</span>packagename
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>当然，前提是git/hg/svn这些工具你都安装好了并且在命令行里面能够执行。</p>

<p>上面这些<code>egg</code>是什么蛋呢？你可以认为它们就是Package源代码和一些metadata打成的压缩包。<code>pip</code>会读取<code>egg</code>里面的<code>setup.py</code>文件，然后安装<code>egg</code>到你的文件系统。</p>

<h5 id="python-1"><strong>从Python源码安装</strong></h5>

<p>从源代码安装虽然是最复杂的，但是也没那么复杂。把你下载的源代码解压之后，找到<code>setup.py</code>所在的路径，然后运行下面的命令：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">python setup.py install
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>也许你觉得这样也挺容易的，为啥要去用<code>pip</code>？因为：</p>

<ul>
  <li>省去你上网找源代码，解压，安装这些动作</li>
  <li>更重要的是，<code>pip</code>不但装，而且管。你可以升级和降级一个Package。</li>
</ul>

<h5 id="package-2"><strong>安装需要编译的package</strong></h5>

<p>这种一般是因为Package里面有c/cpp的代码。如果你能找到别人编译好的exe文件或者用<code>pip</code>，最好不要自己折腾。只有非常非常罕见的情况下你需要自己编译，过程中一般来说都会需要用<code>cygwin</code>之类的东西，在前面几次你可以多看看每个Package的<code>readme</code>关于编译的说明。</p>

<h2 id="section-1">开发环境</h2>

<h5 id="virtualenv"><strong>virtualenv</strong></h5>

<p><code>virtualenv</code>无疑是当前Python开发者心中“必知必会”类的工具了。<code>virtualenv</code>主要就是提供一个“独立的”Python开发环境。为什么需要“独立”的开发环境？在不知道<code>virtualenv</code>之前Python包满坑满谷的本座自然是有很多槽可以吐，不过最好的答案是<code>virtualenv</code>的文档里面说的：</p>

<blockquote><p>The basic problem being addressed is one of dependencies and versions, and indirectly permissions. Imagine you have an application that needs version 1 of LibFoo, but another application requires version 2. How can you use both these applications? If you install everything into /usr/lib/python2.7/site-packages (or whatever your platform’s standard location is), it’s easy to end up in a situation where you unintentionally upgrade an application that shouldn’t be upgraded.</p></blockquote>

<p>简单来说，就是每个工程使用自己独立的<code>virtualenv</code>进行开发，所有该工程需要依赖的Package都安装在这个<code>virutalenv</code>里面。<code>virutalenv</code>的安装同样是使用<code>pip</code>：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">$ </span>pip install virtualenv
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>然后就可以建立属于自己项目的开发环境：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">D:<span class="se">\L</span>enciel<span class="se">\T</span>emp mkdir my_project_env
</span><span class="line">
</span><span class="line">D:<span class="se">\L</span>enciel<span class="se">\T</span>emp<span class="se">\v</span>irtualenv --distribute my_project_env
</span><span class="line">
</span><span class="line">  New python executable in my_project_env<span class="se">\S</span>cripts<span class="se">\p</span>ython.exe
</span><span class="line">  Installing distribute.................done.
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>建立的目录下面会自动的安装好<code>pip</code>等工具：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">-my_project_env
</span><span class="line">  |-- Scripts <span class="c"># -- Python解释器的拷贝/pip脚本/activiate脚本/deactivate脚本等</span>
</span><span class="line">  |-- Lib     <span class="c"># -- 所有库（包括激活后使用pip安装的库都会放在这里</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>在命令行执行activate脚本就可以激活你新建的环境。环境被激活后，主要通过下面两个功能保持独立完整性：</p>

<ol>
  <li>当你在被激活的环境里面使用<code>pip</code>安装一个Package的时候，它只会被安装在这个工作目录下面</li>
  <li>当你<code>import</code>的时候，会先从工作目录下面去搜索，然后才会搜索系统目录下的</li>
</ol>

<p>需要注意的是，在系统目录下面安装的包，对所有的<code>virtualenv</code>建立的环境都是可见的。如果你不想在你建立的<code>virtualenv</code>里面看到这些包，可以使用<code>--no-site-packages</code>参数建立开发环境：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">$ </span>virtualenv my_project_venv --no-site-packages
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="section-2">其他的工具</h2>

<h5 id="section-3"><strong>编辑器</strong></h5>

<p>在不同的项目里面本座用过Vim/Sublime text 2/Eclipse+PyDev/PyCharm。现在Vim和PyCharm用得比较多一点，PyDev一直有一些诡异的问题。比如那个“<a href="https://www.google.com.hk/search?num=30&amp;hl=en&amp;newwindow=1&amp;c2coff=1&amp;safe=strict&amp;site=&amp;source=hp&amp;q=Unresolved+import+pydev&amp;btnK=Google+Search&amp;qscrl=1" target="_blank">Unresolved import</a>”从一开始到现在都好像没有被真正解决过。</p>

<h5 id="section-4"><strong>编码规范</strong></h5>

<p><a href="http://www.python.org/dev/peps/pep-0008/">PEP 0008</a>推荐了非常完整的一套编码规范，目的就是让全世界编写Python脚本的同学们用相同的方式去对齐代码，命名变量、类和函数。每个严肃的Pythoner都应该认真的学习和理解这些规范，并且贯彻执行。</p>

<h5 id="python-2"><strong>Python标准库</strong></h5>

<p>Python的标准库提供了相当完备的功能。就像Java的工程师需要熟悉系统自带的API文档一样，了解标准库的用法是非常有好处的。另外，这些标准库都是很好的范例，特别是在支持跨平台使用这方面。</p>

<p>官方文档在<a href="http://docs.python.org/library/" target="_blank">这里</a>。</p>

<h2 id="section-5">嗯哼</h2>

<p>前面列了不少东西，只是希望给新手一个上路指引。Python下面有用的工具，有趣的包很多很多。随着你学习和应用这门语言，不断深入它，你会自己慢慢发觉那些你自己最需要/愿意熟悉的部分。</p>

<p>Python的另外一大财富就是它的开源社区，条件成熟的时候，你也应该参与到这样的开发活动里面去。</p>

<p>最后是每个Pythoner都津津乐道的Zen Of Python送给刚开始学习的朋友。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">&gt;&gt;&gt;</span><span class="kn">import</span> <span class="nn">this</span>
</span><span class="line"><span class="n">The</span> <span class="n">Zen</span> <span class="n">of</span> <span class="n">Python</span><span class="p">,</span> <span class="n">by</span> <span class="n">Tim</span> <span class="n">Peters</span>
</span><span class="line">
</span><span class="line"><span class="n">Beautiful</span> <span class="ow">is</span> <span class="n">better</span> <span class="n">than</span> <span class="n">ugly</span><span class="o">.</span>
</span><span class="line"><span class="n">Explicit</span> <span class="ow">is</span> <span class="n">better</span> <span class="n">than</span> <span class="n">implicit</span><span class="o">.</span>
</span><span class="line"><span class="n">Simple</span> <span class="ow">is</span> <span class="n">better</span> <span class="n">than</span> <span class="nb">complex</span><span class="o">.</span>
</span><span class="line"><span class="n">Complex</span> <span class="ow">is</span> <span class="n">better</span> <span class="n">than</span> <span class="n">complicated</span><span class="o">.</span>
</span><span class="line"><span class="n">Flat</span> <span class="ow">is</span> <span class="n">better</span> <span class="n">than</span> <span class="n">nested</span><span class="o">.</span>
</span><span class="line"><span class="n">Sparse</span> <span class="ow">is</span> <span class="n">better</span> <span class="n">than</span> <span class="n">dense</span><span class="o">.</span>
</span><span class="line"><span class="n">Readability</span> <span class="n">counts</span><span class="o">.</span>
</span><span class="line"><span class="n">Special</span> <span class="n">cases</span> <span class="n">aren</span><span class="s">&#39;t special enough to break the rules.</span>
</span><span class="line"><span class="n">Although</span> <span class="n">practicality</span> <span class="n">beats</span> <span class="n">purity</span><span class="o">.</span>
</span><span class="line"><span class="n">Errors</span> <span class="n">should</span> <span class="n">never</span> <span class="k">pass</span> <span class="n">silently</span><span class="o">.</span>
</span><span class="line"><span class="n">Unless</span> <span class="n">explicitly</span> <span class="n">silenced</span><span class="o">.</span>
</span><span class="line"><span class="n">In</span> <span class="n">the</span> <span class="n">face</span> <span class="n">of</span> <span class="n">ambiguity</span><span class="p">,</span> <span class="n">refuse</span> <span class="n">the</span> <span class="n">temptation</span> <span class="n">to</span> <span class="n">guess</span><span class="o">.</span>
</span><span class="line"><span class="n">There</span> <span class="n">should</span> <span class="n">be</span> <span class="n">one</span><span class="o">--</span> <span class="ow">and</span> <span class="n">preferably</span> <span class="n">only</span> <span class="n">one</span> <span class="o">--</span><span class="n">obvious</span> <span class="n">way</span> <span class="n">to</span> <span class="n">do</span> <span class="n">it</span><span class="o">.</span>
</span><span class="line"><span class="n">Although</span> <span class="n">that</span> <span class="n">way</span> <span class="n">may</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">obvious</span> <span class="n">at</span> <span class="n">first</span> <span class="n">unless</span> <span class="n">you</span><span class="s">&#39;re Dutch.</span>
</span><span class="line"><span class="n">Now</span> <span class="ow">is</span> <span class="n">better</span> <span class="n">than</span> <span class="n">never</span><span class="o">.</span>
</span><span class="line"><span class="n">Although</span> <span class="n">never</span> <span class="ow">is</span> <span class="n">often</span> <span class="n">better</span> <span class="n">than</span> <span class="o">*</span><span class="n">right</span><span class="o">*</span> <span class="n">now</span><span class="o">.</span>
</span><span class="line"><span class="n">If</span> <span class="n">the</span> <span class="n">implementation</span> <span class="ow">is</span> <span class="n">hard</span> <span class="n">to</span> <span class="n">explain</span><span class="p">,</span> <span class="n">it</span><span class="s">&#39;s a bad idea.</span>
</span><span class="line"><span class="n">If</span> <span class="n">the</span> <span class="n">implementation</span> <span class="ow">is</span> <span class="n">easy</span> <span class="n">to</span> <span class="n">explain</span><span class="p">,</span> <span class="n">it</span> <span class="n">may</span> <span class="n">be</span> <span class="n">a</span> <span class="n">good</span> <span class="n">idea</span><span class="o">.</span>
</span><span class="line"><span class="n">Namespaces</span> <span class="n">are</span> <span class="n">one</span> <span class="n">honking</span> <span class="n">great</span> <span class="n">idea</span> <span class="o">--</span> <span class="n">let</span><span class="s">&#39;s do more of those!</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Happy Pythoning…!!</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2012/02/integration-of-proguard-and-maven-in-android-projects/">Android开发中使用ProGuard</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-27T22:46:00+08:00" pubdate data-updated="true">Feb 27<span>th</span>, 2012</time>
        
         | <a href="/2012/02/integration-of-proguard-and-maven-in-android-projects/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>今天被同事问到怎么在release版本里面所有的日志都去掉的时候，竟然只能回忆起用<code>ProGuard</code>做过这个，完全忘记怎么做的了，特立此存照。文章里面使用的例子放在<a class="network" href="https://github.com/lenciel/AMP" rel="me"><img src="/downloads/images/github_button.png" alt="" width="16" height="16" /> Android-Maven-ProGuard-Sample-App</a>。</p>

<h4 id="proguard">ProGuard简介</h4>

<p>在移动设备上面开发应用程序，性能是一个很关键的指标。你的老板走过来要你提高性能的时候，你的第一反应有可能是抓起熟悉的工具花几个小时profile自己的应用，找出那些时间都花在哪里了。在使用这么终极的手段之前，千万不要忘记了先试试ProGuard。</p>

<p>做Android之前就是Java程序员的可能早就已经对ProGuard很熟悉了。简单的来说，ProGuard就是一个Java的class文件处理器，主要的功能类似奥运会口号：</p>

<ul>
  <li>让你的程序变得更小更快 </li>
  <li>让你的程序变得更难被反向工程 </li>
</ul>

<p>尽管ProGuard不是专用于Android开发的，但是在Android的SDK里面已经包括了这个工具，路径是<code>ANDROID_HOME/tools/proguard</code>，文档可以在<a href="http://proguard.sourceforge.net">http://proguard.sourceforge.net</a>看到。</p>

<p>让程序变得更小更快的好处是不言而喻的。ProGuard通过对bytecode进行优化，优化手段包括去掉无用的代码，去掉内联方法的调用，对类的继承结构进行优化，把所有能加上的<code>final</code>和<code>static</code>加上，以及对算术运算进行<a href="http://en.wikipedia.org/wiki/Peephole_optimization" target="_blank">Peephole optimization</a>等等。</p>

<p>让程序变得更难被反向工程就不一定是每个人都需要的了。一般情况下，对Android的反向工程是把Dalvik的bytecode转换成Java的bytecode，然后使用传统的Java反向工具转成成Java源代码。如果你的项目是开源的，显然也没有必要防止别人反向。但是如果是下面几种情况，你就很可能需要它了： </p>

<ul>
  <li>你在源文件里面有一些不想被别人看到的信息，如密码等 </li>
  <li>你的代码里面有自己或者公司的赖以生存的知识产权 </li>
  <li>你的甲方有明确的要求 </li>
  <li>你的程序按license等方式收费，你不想被别人把licens检查的部分去掉重新编译个版本 </li>
</ul>

<p>ProGuard可以帮助通过对类，方法和成员名称进行混淆，同时通过去掉结构化的信息，如文件名或者行号表等，来使得代码从理论上变得不可被反向工程。</p>

<p>如此看来，ProGuard真是美好事物一枚。但是ProGuard也不是随手一点药到病除的，也有一点学习曲线。</p>

<h4 id="proguard-1">启用ProGuard</h4>

<p>如果你使用Eclipse的ADT，每个新建的项目都会生成一个<code>proguard.cfg</code>文件在项目的根目录。你对ProGuard的所有设定就是在这个文件里面完成的。要想在项目里面启用Proguard，只需要把同样在项目根目录的<code>default.properties</code>里面加上：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">proguard.config<span class="o">=</span>proguard.cfg
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>当然，如果你蛋疼到要自己去移动cfg文件的位置，也要记得去改等号后面的部分。然后，在所有的release版本的build里，你的Proguard就已经生效了。对于使用Eclipse的同学来说，release的build就是指通过选择Android Tools&gt;Export Signed/Unsigned Application Package来进行。</p>

<p>因为在大多数开发中我们都会使用Ant或者是Maven来对项目进行管理，所以一般不会直接用Eclipse来进行release版本的编译，所以通常我们还要掌握如何在不使用ADT的情况下使用ProGuard。对于Maven而言，可以通过使用Maven Android plugin来完成。同时，由于ProGuard已经完全集成到Android的工具链里面了，所以Android的Ant任务里面也有一个专门的private任务叫做<code>-obfuscate</code>，会把激活并使用ProGuard作为release这个target的一部分，所以使用Ant的话只要一个ant release就可以了。</p>

<p>当ProGuard执行以后，会产生几个特别重要的文件：</p>

<ul>
  <li><code>mapping.txt</code>：保存了混淆后的名字和混淆前名字的对应关系。对于每次release的build，都要记得保存这个文件，要不然如果你收到release版本上报出的defect的时候，就等着哭吧。 </li>
  <li><code>seeds.txt</code>：ProGuard找到的你的程序的entrypoint列表。 </li>
  <li><code>usage.txt</code>：ProGuard觉得没有用所以移除了的一堆类，域和方法的list。要想学习写作“完美”的ProGuard规则的同学就要经常来这个文件看看自己定下的rule对ProGuard的行为究竟有什么样的影响。如果你有用的类出现在list里面了，说明你削得太猛了，反之亦然。</li>
</ul>

<p>需要注意的是这些文件的输出目录。在使用Ant ProGuard target的时候，输出目录是<code>bin/proguard/</code>，但是如果是通过ADT(右键project&gt;Android Tools&gt;Export）的话，输出目录会是<code>proguard/</code>。</p>

<p>还有一个常见的困惑就是ProGuard是怎么找到那些需要处理的文件的。一般情况下，ProGuard希望你用<code>-injars</code>或者是<code>-libraryjars</code>来告诉它。但是对Android开发而言，Ant任务和ADT都会自动的查看你的<code>libs</code>，<code>output</code>和项目的<code>classpath</code>目录。</p>

<p>从执行过程的日志来看，ProGuard对类文件的操作分为三个步骤：shrink，optimize，obfuscate。每个步骤都是可选的，可以通过使用<code>-dontshrink</code>、<code>-dontoptimize</code>和<code>-dontobfuscate</code>来分别关掉。一般来说，不用因为结果“不如人意”就随意的关掉某个步骤。完整的进行三个步骤，然后不断的改变规则，直到达到最佳效果，是使用ProGuard的最佳方式。</p>

<h4 id="proguard-2">编写ProGuard规则</h4>

<p>ProGuard和很多工具一样，其强大之处在于选项够多。作为Android开发者使用，首先心里要明白，没有一个唯一的最佳配置规则。在此基础上，去掌握一些对Android程序而言通常是适用的规则。然后，就像在文章里面已经反复强调过的一样，以这些规则为起点，反复的调整你的规则，找出一个对自己的程序最适用的规则。</p>

<p>当然，因为选项太多，ProGuard给初学者的感觉难免是千头万绪，无从下手。因此，我们可以从一个例子程序入手来找到对ProGuard的“感觉”。</p>

<p>这个例子本身没有任何特别之处，<code>MyButton</code>类继承自<code>Button</code>但是没有添加新的方法，可以通过它来观察ProGuard如何对继承结构进行压缩。Click的handler除开显示toast之外也没有特别的功能，可以通过它来观察ProGuard对方法名的混淆。<code>AMPSampleActivity</code>里面还专门有一个没有被调用的方法，可以通过它来观察ProGuard对这种情况的处理。下面是程序的入口Activity的实现：</p>

<p>我们期望ProGuard做的事情包括：</p>

<ul>
  <li>保留<code>AMPSampleActivity</code>类，因为它是我们在XML里面指定的程序入口 </li>
  <li>保留<code>StringUtils</code>类和它的<code>repeat</code>方法 </li>
  <li>保留<code>myClickHandler</code>方法 </li>
  <li>保留<code>MyButton</code>类 </li>
  <li>去掉<code>unusedMethod</code> </li>
  <li>除开XML里面引用的类（<code>AMPSampleActivity</code>和<code>MyButton</code>），其他的类名都需要被混淆 </li>
  <li>除开XML里面引用的方法名（<code>myClickHandler</code>），其他的方法名都要被混淆 </li>
  <li>完成一些对Android而言通常适用的优化（下面会仔细展开） </li>
</ul>

<p>ProGuard的规则是“白名单”的，也就是说ProGuard只会对你特别指定的类刀下开恩。这也就是说，对任何程序，我们都至少要写一条规则，来保留程序的入口类。因为是Android程序，我们可以这么写：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="o">-</span><span class="n">keep</span> <span class="kd">public</span> <span class="kd">class</span> <span class="err">* </span><span class="nc">extends</span> <span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">Activity</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>这里我们可以看到ProGuard的rule用的语法基本上遵循了Java本身的语法（<code>extends</code>等等），但是它支持使用通配符。规则中的<code>-keep</code>告诉ProGuard不要删除也不要混淆任何从<code>android.app.Activity</code>继承的类。</p>

<p>很简单，不是吗？如果你这个时候运行程序，会看到： </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">org</span><span class="o">.</span><span class="na">lenciel</span><span class="o">.</span><span class="na">android</span><span class="o">/</span><span class="n">org</span><span class="o">.</span><span class="na">lenciel</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">AMPSampleActivity</span><span class="o">}:</span>
</span><span class="line">    <span class="err">➥</span> <span class="n">android</span><span class="o">.</span><span class="na">view</span><span class="o">.</span><span class="na">InflateException</span><span class="o">:</span> <span class="n">Binary</span> <span class="n">XML</span> <span class="n">file</span> <span class="n">line</span> <span class="err">#</span><span class="mi">6</span><span class="o">:</span> <span class="n">Error</span> <span class="n">inflating</span>
</span><span class="line">    <span class="err">➥</span> <span class="kd">class</span> <span class="nc">org</span><span class="o">.</span><span class="na">lenciel</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">MyButton</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>为什么在inflate我们自定义的view的时候crash了呢？这是因为自定义的view是在XML里面被用到的，而不是在Java代码里面。因此ProGuard会认为这是没有用的代码而试着删除它。要保证这些自定义的view不被误删，就需要定义如下的规则：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="o">-</span><span class="n">keepclasseswithmembers</span> <span class="kd">class</span> <span class="err">* {</span>
</span><span class="line">    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">init</span><span class="o">&gt;(</span><span class="n">android</span><span class="o">.</span><span class="na">content</span><span class="o">.</span><span class="na">Context</span><span class="o">,</span> <span class="n">android</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">AttributeSet</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="o">-</span><span class="n">keepclasseswithmembers</span> <span class="kd">class</span> <span class="err">* {</span>
</span><span class="line">    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">init</span><span class="o">&gt;(</span><span class="n">android</span><span class="o">.</span><span class="na">content</span><span class="o">.</span><span class="na">Context</span><span class="o">,</span> <span class="n">android</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">AttributeSet</span><span class="o">,</span> <span class="kt">int</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>这两条规则告诉ProGuard不要对定义了可能被<code>LayoutInflater</code>调用的构造函数的任何类进行优化。我们这里使用了<code>-keepclasseswithmembers</code>而不是<code>-keep</code>。</p>

<p>再次运行，会遇到下面的错误：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">IllegalStateException</span><span class="o">:</span> <span class="n">Could</span> <span class="n">not</span> <span class="n">find</span> <span class="n">a</span> <span class="n">method</span>
</span><span class="line">   <span class="err">➥</span> <span class="n">myClickHandler</span><span class="o">(</span><span class="n">View</span><span class="o">)</span> <span class="n">in</span> <span class="n">the</span> <span class="n">activity</span> <span class="kd">class</span> <span class="nc">org</span><span class="o">.</span><span class="na">lenciel</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">AMPSampleActivity</span> <span class="k">for</span> <span class="n">onClick</span> <span class="n">handler</span> <span class="n">on</span>
</span><span class="line">   <span class="err">➥</span> <span class="n">view</span> <span class="kd">class</span> <span class="nc">org</span><span class="o">.</span><span class="na">lenciel</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">MyButton</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>去查看<code>usage.txt</code>你会发现<code>myClickHandler</code>又被干掉了。为什么在第一条规则里面我们告诉ProGuard不要动<code>AMPSampleActivity</code>里面的任何东西，还是会有这种情况发生？这是使用<code>-keep</code>的一个常见的误会。我们用<code>-keep</code>告诉ProGuard保留一个类的时候，没有提供任何类的“body”信息的话，ProGuard仅仅会保留这个类的名字。它仍然会对这个类内部的所有东西进行优化和混淆。要保留方法，我们需要这么写：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="o">-</span><span class="n">keep</span> <span class="kd">public</span> <span class="kd">class</span> <span class="err">* </span><span class="nc">extends</span> <span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">Activity</span> <span class="o">{</span>
</span><span class="line">    <span class="n">methods</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>但是这样写显然又太过于慷慨了。下面这条规则会好很多：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="o">-</span><span class="n">keepclassmembers</span> <span class="kd">class</span> <span class="err">* </span><span class="nc">extends</span> <span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">Activity</span> <span class="o">{</span>
</span><span class="line">    <span class="kd">public</span> <span class="kt">void</span> <span class="o">*(</span><span class="n">android</span><span class="o">.</span><span class="na">view</span><span class="o">.</span><span class="na">View</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>这条规则告诉ProGuard，如果一个<code>Activity</code>在<code>shrink</code>阶段没有被去掉，那么就保留那些<code>public</code>的，没有返回值的，传入了<code>android.view.View</code>作为参数的方法。</p>

<p>可以看到，使用ProGuard存在一个不断调优的过程。他山之石，可以攻玉，已经有很多人使用ProGuard来优化Android程序了，于是也有了一些被普遍采用的规则和选项，我们下面来个简单说明。</p>

<h4 id="section">常用规则和选项</h4>

<p>前面看到的规则对于例子程序就足够了。但是如果我们的程序使用了<code>Service</code>怎么办？和<code>Activity</code>一样，<code>Service</code>也是在manifest xml里面定义的，因此我们需要对<code>proguard.cfg</code>做一定的扩展。</p>

<p>下面的规则是针对Android程序一般来说都比较有效的。</p>

<p>一般来说，下面的Android framework class都是需要保留的：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="o">-</span><span class="n">keep</span> <span class="kd">public</span> <span class="kd">class</span> <span class="err">* </span><span class="nc">extends</span> <span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">Activity</span>
</span><span class="line"><span class="o">-</span><span class="n">keep</span> <span class="kd">public</span> <span class="kd">class</span> <span class="err">* </span><span class="nc">extends</span> <span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">Application</span>
</span><span class="line"><span class="o">-</span><span class="n">keep</span> <span class="kd">public</span> <span class="kd">class</span> <span class="err">* </span><span class="nc">extends</span> <span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">Service</span>
</span><span class="line"><span class="o">-</span><span class="n">keep</span> <span class="kd">public</span> <span class="kd">class</span> <span class="err">* </span><span class="nc">extends</span> <span class="n">android</span><span class="o">.</span><span class="na">content</span><span class="o">.</span><span class="na">BroadcastReceiver</span>
</span><span class="line"><span class="o">-</span><span class="n">keep</span> <span class="kd">public</span> <span class="kd">class</span> <span class="err">* </span><span class="nc">extends</span> <span class="n">android</span><span class="o">.</span><span class="na">content</span><span class="o">.</span><span class="na">ContentProvider</span>
</span><span class="line"><span class="o">-</span><span class="n">keep</span> <span class="kd">public</span> <span class="kd">class</span> <span class="err">* </span><span class="nc">extends</span> <span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">backup</span><span class="o">.</span><span class="na">BackupAgentHelper</span>
</span><span class="line"><span class="o">-</span><span class="n">keep</span> <span class="kd">public</span> <span class="kd">class</span> <span class="err">* </span><span class="nc">extends</span> <span class="n">android</span><span class="o">.</span><span class="na">preference</span><span class="o">.</span><span class="na">Preference</span>
</span><span class="line"><span class="o">-</span><span class="n">keep</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">vending</span><span class="o">.</span><span class="na">licensing</span><span class="o">.</span><span class="na">ILicensingService</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>虽然你的程序可能一开始没有使用其中的一些类，但是定义好全部这些规则也是有好处的：它可以避免你在使用ProGuard编出的版本crash之后去搞半天才发现有某个类似的规则需要更新但是你忘记了。</p>

<p>第二个有用的规则是保留<code>static</code>的<code>CREATOR</code>域，这个是Android用来parcel对象的。这个域由于是在运行的时候<a href="http://www.google.com.hk/url?sa=t&amp;rct=j&amp;q=introspection&amp;source=web&amp;cd=2&amp;ved=0CDYQFjAB&amp;url=http%3A%2F%2Fen.wikipedia.org%2Fwiki%2FIntrospection&amp;ei=_JhDT-6ADIGtiQfF46TMBA&amp;usg=AFQjCNEEE1rrErPfi38AVCPjdN6ri-qROA" target="_blank">Instrospection</a>的，所以ProGuard会认为它是无用的域并把它去掉。下面这条rule可以防止这样的事情发生：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="o">-</span><span class="n">keepclassmembers</span> <span class="kd">class</span> <span class="err">* </span><span class="nc">implements</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcelable</span> <span class="o">{</span>
</span><span class="line">    <span class="kd">static</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Parcelable</span><span class="n">$Creator</span> <span class="n">CREATOR</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>在程序中如果你调用了native的code，比如你用JNI来调用了c的lib，由于在Java代码里面是一份方法的签名，而没有方法的实现，它必须被链接到native code上。这也就意味着这些函数名不能被ProGuard加以混淆了，不然链接的过程就会失败。下面的规则可以保证ProGuard不去动native的方法名：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="o">-</span><span class="n">keepclasseswithmembernames</span> <span class="kd">class</span> <span class="err">* { </span>
</span><span class="line">     <span class="kd">native</span> <span class="n">methods</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>我们这里使用的<code>-keepclasseswithmembernames</code>是告诉ProGuard，被调用过的方法留着，没有调用过的都去掉。</p>

<p>前面的规则看起来都一目了然。下面这个可能要费解一些：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="o">-</span><span class="n">keepclassmembers</span> <span class="kd">enum</span> <span class="o">*</span> <span class="o">{</span>
</span><span class="line">     <span class="kd">public</span> <span class="kd">static</span> <span class="o">**[]</span> <span class="n">values</span><span class="o">();</span>
</span><span class="line">     <span class="kd">public</span> <span class="kd">static</span> <span class="o">**</span> <span class="n">valueOf</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>这个规则是让ProGuard不要去动任何<code>Enum</code>的<code>values</code>和<code>valueOf</code>方法。这些方法之所以特殊是因为Java自己是通过发射机制来调用它们的。这可能也是Google<a href="https://developer.android.com/guide/practices/design/performance.html#avoid_enums" target="_blank">不建议使用</a>Java enum的原因吧：它们比<code>final class fields</code>的性能要低不少。如果你已经遵照Google的教诲停止使用<code>Enum</code>，那你也不需要这条规则了，恭喜。</p>

<p>下面来看看常用的选项：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="o">-</span><span class="n">dontusemixedcaseclassnames</span>
</span><span class="line"><span class="o">-</span><span class="n">dontskipnonpubliclibraryclasses</span>
</span><span class="line"><span class="o">-</span><span class="n">dontpreverify</span>
</span><span class="line"><span class="o">-</span><span class="n">verbose</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>第一个选项可以避免像Windows这样不区分大小写的操作系统不会因为类似<code>A.class</code>和<code>a.class</code>写到同一个文件里面就驾崩。</p>

<p>第二个选项是因为ProGuard默认不会处理任何非public的类。但是有时候我们会遇到public的类继承自内部的非public的类。所以打开这个选项可以更好的覆盖。</p>

<p>第三个选项是告诉ProGuard不要做<code>preverify</code>（预检验），因为这个只对J2ME或者是Java6的平台有用。</p>

<p>最后一个选项，你们懂的。</p>

<p>前面我们提到过ProGuard有一个优化代码（optimize）的过程。大多数时候ProGuard都会火力全开的对所有的代码做优化。这些优化操作有些时候是相当aggressive的，比如合并类的时候ProGuard会试着既从纵向上合并也从横向上合并，以便得到尽量少的类文件，也就可以得到尽量小的APK。同时它还会试着优化循环和代数运算。默认的ADT生成的ProGuard选项关掉了很多的优化选项：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="o">-</span><span class="n">optimizations</span> <span class="o">!</span><span class="n">code</span><span class="o">/</span><span class="n">simplification</span><span class="o">/</span><span class="n">arithmetic</span><span class="o">,!</span><span class="n">field</span><span class="o">/*,!</span><span class="n">class</span><span class="o">/</span><span class="n">merging</span><span class="o">/*</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Google并没有提供他们这么配置的依据。我们可以试着先禁用这个选项，看看程序运行起来会不会有问题。如果遇到了问题再试着慢慢的减弱优化，来“探底”。</p>

<p>同时ProGuard的优化是可以“递归”的，也就是优化完的结果可以作为下次优化的输入继续优化。你可以指定它反复进行多少次。但ProGuard如果发现已经没有什么可以优化，会自动停下来，不一定跑到你指定的次数。一般设置成5就够了：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="o">-</span><span class="n">optimizationpasses</span> <span class="mi">5</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4 id="section-1">如果处理混淆后版本的错误报告</h4>

<p>如果你发布了混淆的版本，有一个问题你就得面对：用户提交的问题单里面产生自这些类和方法都完全打乱过后的版本。为了展示这种问题，在Demo程序里面专门加了这么一个类：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Bomb</span> <span class="o">{</span>
</span><span class="line">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">explode</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">&quot;Boom!&quot;</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>在onCreate方法里面它会被引爆：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
</span><span class="line">    <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">main</span><span class="o">);</span>
</span><span class="line">    <span class="n">String</span> <span class="n">toast</span> <span class="o">=</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">repeat</span><span class="o">(</span><span class="s">&quot;Hello ProGuard! &quot;</span><span class="o">,</span> <span class="mi">3</span><span class="o">);</span>
</span><span class="line">    <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">toast</span><span class="o">,</span> <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
</span><span class="line">    <span class="k">new</span> <span class="nf">Bomb</span><span class="o">().</span><span class="na">explode</span><span class="o">();</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>如果你运行程序，就会看到下面的错误：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">RuntimeException</span><span class="o">:</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">start</span> <span class="n">activity</span> <span class="o">...</span><span class="na">MainActivity</span><span class="o">}:</span>
</span><span class="line"><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">RuntimeException</span><span class="o">:</span> <span class="n">Boom</span><span class="o">!</span>
</span><span class="line"><span class="o">...</span>
</span><span class="line"><span class="n">Caused</span> <span class="nl">by:</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">RuntimeException</span><span class="o">:</span> <span class="n">Boom</span><span class="o">!</span>
</span><span class="line">   <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">lenciel</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">MainActivity</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">Unknown</span> <span class="n">Source</span><span class="o">)</span>
</span><span class="line">   <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">Instrumentation</span><span class="o">.</span><span class="na">callActivityOnCreate</span><span class="o">(</span>
</span><span class="line">   <span class="err">➥</span> <span class="n">Instrumentation</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1047</span><span class="o">)</span>
</span><span class="line">   <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">app</span><span class="o">.</span><span class="na">ActivityThread</span><span class="o">.</span><span class="na">performLaunchActivity</span><span class="o">(</span>
</span><span class="line">   <span class="err">➥</span> <span class="n">ActivityThread</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">2627</span><span class="o">)</span>
</span><span class="line">   <span class="o">...</span> <span class="mi">11</span> <span class="n">more</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>可以看到在错误出现位置的stack trace既没有行号也没有文件名。这是因为相关的信息都被ProGuard优化掉了。如果我们想避免这种情况，就要在<code>proguard.cfg</code>里面加上下面的选项：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">-keepattributes SourceFile,LineNumberTable
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>显然，有了行号和文件名，还是解决不了方法被混淆的问题。我们这个例子程序里面方法很少，而<code>onCreate</code>方法因为是<code>Override</code>的，所以ProGuard不会去动它。如果是正式的工程，最好的办法还是用<code>retrace</code>工具来根据<code>mapping.txt</code>还原整个日志。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">$ </span>retrace proguard/mapping.txt stacktrace.txt
</span></code></pre></td></tr></table></div></figure></notextile></div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2012/01/plan-for-2012/">Plan for 2012</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-01-10T11:07:00+08:00" pubdate data-updated="true">Jan 10<span>th</span>, 2012</time>
        
         | <a href="/2012/01/plan-for-2012/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="/downloads/images/2012_great_view.jpg" alt="2012 Great View" title="Don't touch me..." /></p>

<p>在读过《<a href="http://book.douban.com/subject/3609132/" target="_blank">把时间当作朋友</a>》和<a href="http://matt.might.usesthis.com/" target="_blank">Matt Might</a>的文章之后，回首2011就让人觉得莫名慌张起来。按《<a href="http://book.douban.com/subject/3609132/" target="_blank">把时间当作朋友</a>》这本书里所说，定计划要以周为单位，通过培养自己对时间的控制力，逐步把计划做到月甚至年这样的跨度。本座自觉还算比较能控制自己，所以打算制作一个基本单位为月的计划，下面的十项活动将穿插在这个计划之中：</p>

<ol>
  <li>一点新知识   </li>
  <li>一砣好身体</li>
  <li>一个新玩具   </li>
  <li>一批新兴趣   </li>
  <li>一门新语言   </li>
  <li>一款新软件   </li>
  <li>一马新项目   </li>
  <li>一把新文艺 </li>
</ol>

<h4 id="section"><strong>一点新知识</strong></h4>

<p>用进废退，数理化史地生音体美忘记了就算了吧。但半路出家的本座，还有很多基础知识也非常单薄。准备了6本不那么理论的书，争取能用2个月一本的龟速精读：</p>

<ul>
  <li><a href="http://www.amazon.com/Code-Language-Computer-Hardware-Software/dp/0735611319/ref=sr_1_1?ie=UTF8&amp;qid=1326115601&amp;sr=8-1" target="_blank">Code: The Hidden Language of Computer Hardware and Software</a> </li>
  <li><a href="http://book.douban.com/subject/4327796/" target="_blank">Continuous Delivery</a> </li>
  <li><a href="http://www.amazon.com/dp/0201752840/?tag=stackoverfl08-20" target="_blank">Database Design for Mere Mortals</a> </li>
  <li><a href="http://www.amazon.com/Event-Processing-Action-Opher-Etzion/dp/1935182218/ref=sr_1_1?s=books&amp;ie=UTF8&amp;qid=1326115894&amp;sr=1-1" target="_blank">Event Processing in Action</a> </li>
  <li><a href="http://www.amazon.com/Art-Concurrency-Monkeys-Parallel-Applications/dp/0596521537/ref=sr_1_1?ie=UTF8&amp;qid=1326115671&amp;sr=8-1" target="_blank">The Art of Concurrency</a> </li>
  <li><a href="Designing the Obvious" target="_blank" class="broken_link">Designing the Obvious</a> </li>
</ul>

<h4 id="section-1"><strong>一砣好身体</strong></h4>

<p>关注自己的健康状况，保持适当的体育锻炼，既是对自己负责，也是对家人负责。2012年体育锻炼方面的发展目标是除开足球之外，要开拓可以和偶像派互动的项目。下面的四个项目，12个月都可以开展，但是可以根据气候的不同，在四个季度各有偏重：</p>

<ul>
  <li>跳绳 </li>
  <li>自行车 </li>
  <li>跑步 </li>
  <li>羽毛球 </li>
</ul>

<p>另外，程序员这个职业带来的伤害常常是<a href="http://en.wikipedia.org/wiki/Repetitive_strain_injury" target="_blank">RSI</a>。本座一直有比较严重的脖子疼和曾经越来越严重的肩膀和手腕疼。通过了解RSI，保持良好的姿势以及定时起来活动，比较好的缓解了疼痛。但是用电脑有时候是一屁股下去就不好起来的。让人欣喜的，传说中的<a href="http://www.hermanmiller.com/Products/Aeron-Chairs" target="_blank">Aeron</a>在中国<a href="http://www.hermanmiller.cn/" target="_blank">也能</a>买到了。所以明年还有一个目标：</p>

<ul>
  <li><a href="http://www.hermanmiller.com/Products/Aeron-Chairs" target="_blank">Aeron</a> </li>
</ul>

<h4 id="section-2"><strong>一个新玩具</strong></h4>

<p>在回成都之后第一年在E公司主要的玩具是那套收星的玩意儿。原来只要大概800块钱左右的成本(DM500和所有的分路器合路器F头都是在这家淘宝店<a href="http://boattv.taobao.com/?spm=1101_lrm.4-Q8vp.2-91JMq" target="_blank">买的</a>），就可以用60CM的锅收<a href="http://www.cnsat.net/134.0.htm" target="_blank">134</a>/<a href="http://www.cnsat.net/138.0.htm" target="_blank">138</a>/146三颗ku星。</p>

<p>接下来移籍M公司，主要的玩具似乎变成了Android。但是后来机缘巧合开始接触了各式各样的监控设备。说实在的从前端的IP化的云台枪机，到DVR，到最后的矩阵上墙，里面还是有很多挺有趣的技术。而且像中国这么大一个工地，到处都要装监控，这里面商机也不小。</p>

<p>明年如果能说动偶像派买个LEGO的<a href="http://mindstorms.lego.com/en-us/Default.aspx" target="_blank">MindStorm</a>当然是最好，如果失败，就入手最近红到爆的<a href="http://www.arduino.cc/" target="_blank">Arduino</a>，话说本座已经堆了很多这方面的书了都没有真正花时间去看过。可是作为控制系的学生，每次看到它们，都有难以抑制的原始冲动。这种东西，一年玩一个就足够了：</p>

<ul>
  <li><a href="http://mindstorms.lego.com/en-us/Default.aspx" target="_blank">MindStorm</a>  or </li>
  <li><a href="http://www.arduino.cc/" target="_blank">Arduino</a> </li>
</ul>

<h4 id="section-3"><strong>一批新兴趣</strong></h4>

<p>编程的很多道理你不一定只能在编程中学到，因为人类最先进的学习方法是类比。</p>

<p>而且，每天坐在电脑前面的老公在老婆和其他亲属心中的仇恨值是很高的。下面是一批本座觉得有可能进化为兴趣爱好并能够得到偶像派的广泛赞许和普遍接受的备选项目。仍然是均分到各个月份，但每个季度有倾斜的加大某项的比重：</p>

<ul>
  <li>摄影 </li>
  <li>画画 </li>
  <li>写毛笔字 </li>
  <li>厨艺 </li>
</ul>

<h4 id="section-4"><strong>一门新语言</strong></h4>

<p>程序员之所以被认为是个苦逼的职业，很重要的原因就是技术更新换代很快。去年看完《<a href="http://book.douban.com/subject/4768035/" target="_blank">Seven Languages in Seven Weeks</a>》之后本座就有计划学一下Haskell和Scala，但是去了一趟杭州拿到冰河翻译的<a href="http://book.douban.com/subject/6859720/" target="_blank">新书</a>之后本座把明年的目标换成了下面两个，每个半年：</p>

<ul>
  <li><a href="http://www.apl.jhu.edu/~hall/lisp.html" target="_blank">Lisp</a> </li>
  <li><a href="http://www.haskell.org/" target="_blank">Haskell</a> </li>
</ul>

<h4 id="section-5"><strong>一款新软件</strong></h4>

<p>人的创造力需要反复而大量的的基础知识和实作经验垫底，而基础知识和实作经验往往蕴藏在那些已经被时间验证过的作品里。所以要想拍好电影得看很多好电影，要想写好书得看很多好书，要想写出好软件得用很多好软件。在使用别人的软件时，可以想想如果是自己来写，什么地方做得比它好，什么地方还需要像别人学习。暂定的目标有：</p>

<ul>
  <li><a href="http://www.ispyconnect.com" target="_blank">iSpy</a> </li>
  <li><a href="http://c9.io/" target="_blank">Cloud9</a> </li>
  <li><a href="http://www.rapidftr.com/" target="_blank">RAPIDFTR</a> </li>
  <li><a href="http://www.openstack.org/" target="_blank">OpenStack</a> </li>
</ul>

<h4 id="section-6"><strong>一马新项目</strong></h4>

<p>写软件谋生的好处是不言而喻的，坏处是如果你老是只为了工资奖金写软件，慢慢的你就会感觉到“无趣”。无趣的根源很多，最主要的无非“人家想用xyz，但是只能用zyx”。其实有<a href="https://github.com/" target="_blank">Github</a>和<a href="https://bitbucket.org/" target="_blank">Bitbucket</a>之后，这些都是借口啊，亲。项目内容暂时保密。</p>

<h4 id="section-7"><strong>一把新文艺</strong></h4>

<p>还在读研究生的时候(也是J2EE最红火的时候？)，本座发现一件“奇闻“：<a href="http://www.springsource.org/" target="_blank">Spring</a>的作者Rod Johnson说之所以自己能写出拨乱反正的《<a href="http://book.douban.com/subject/1426848/" target="_blank">Expert One-on-one</a>》和<a href="http://www.springsource.org/" target="_blank">Spring</a>，和他学习过的音乐知识是分不开的。Google了一下，原来他除开有计算机学位还是个音乐学博士。</p>

<p>之后稍微留心就发现，这是一个普遍的现象。比如那个写微积分教材赚的钱就可以建2400w刀豪宅的音乐家<a href="http://www.thestar.com/news/article/933017--the-house-that-math-built" target="_blank">James Stewart</a>，再比如2011年最被关注的去世者<a href="http://en.wikipedia.org/wiki/Steve_Jobs" target="_blank">Steve Jobs</a>。有点儿文艺细胞，能从人性的角度思考，做出的产品往往比纯粹的工程产品要打动人心。</p>

<p>本座挺佩服自己能找出这么一个伟大的理由，得以在新的一年里继续毫无节制的：</p>

<ul>
  <li>看电影 </li>
  <li>读小说 </li>
  <li>听音乐 </li>
</ul>

<p>要顺利贯彻执行计划，总得有个考核标准。打算今后多写一点儿blog记录在案，不然也对不起本座A给酋长的银子啊：</p>

<p><img src="/downloads/images/vhost_threshold.png" alt="Vhost threshold" title="Don't touch me..." /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/11/long-live-old-times/">老无所依</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-20T12:50:00+08:00" pubdate data-updated="true">Nov 20<span>th</span>, 2011</time>
        
         | <a href="/2011/11/long-live-old-times/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="/downloads/images/2011_11/IMG_0313.jpg" alt="long live old times" title="Don't touch me..." /></p>

<p>国庆回了一趟银厂沟白水河。出发的那天天气并不好，可是对爸妈而言，去看看那个安放了自己青春的地方，已经计划过太多次而不能成行。所以犹豫了一下，就决定还是要去。</p>

<p>车一开进山区，因为属于汶川大地震里山崩地裂的龙门山山脉，那场灾难留下的痕迹依然随处可见。然而地貌上的变化却并不是爸妈最关注：一路上他们不断提起的是故人的名字，以及自己和他们之间的种种旧事。有的时候我爸会往路边一指说，“那不是黄村吗？以前你妈下乡在那里的时候，我骑车来看过她。”有的时候我妈又会指着另一个地方说，“那个谁谁谁，就是在这里被掉下来的房梁打死了，太可惜了。”</p>

<p>而白水河对于我，因为是十岁之前生活的地方，本来就没有多少刻骨铭心的记忆。加上我和Konthiga读过的小学和学校后面那条曾经清澈而壮阔的白水河，在上次回去的时候就已经面目全非了，于是唯一怀着兴趣的就只剩据说在地震里面一栋都没有倒的蛇纹矿家属区，也就是我们当年长大的地方。坐在我旁边的偶像派，在我们一家人兴致勃勃的指着窗外大呼小叫时，则多少显得有些百无聊赖。</p>

<p>后来事情的发展让人觉得略感尴尬。走到“鬼招手”（银厂沟一个以险峻著称的地段）的时候，前面的山路突然淹没在浓雾之中，我们只好调头，放弃了继续进沟的打算。接下来在大宝镇上兜了两圈，我们才凭借着整条街上几乎是唯一没有被拆除的新华书店，定位到了我们原来的住处：居然已经是一片平地。</p>

<p>回到家里，我突然有些不死心的想把记忆里的白水河挖出来，就去翻家里的老照片。</p>

<p>首先让我觉得特别温暖的是装老照片的这个信封。这是外公写给我妈的，不知道当年那封信具体写得是啥。在这根本不用写信甚至不用写字的时代生活久了，这样的物件总给人一种特别的质感。</p>

<p><img src="/downloads/images/2011_11/IMG_0366_1.png" alt="long live old times" title="Don't touch me..." /></p>

<p>我还找到了几张Konthiga和我都还挺萌的时候的照片。这个阶段我们的衣服全是老爸用缝纫机做的，看着都是一段段特别的回忆。另外从红领巾出现的频率来看，除了伟大的六一儿童节，我们一直对照相这事情兴趣不大。</p>

<p><span style="widows: 2; text-transform: none; text-indent: 0px; letter-spacing: normal; border-collapse: separate; font: medium tahoma; white-space: normal; orphans: 2; color: rgb(0,0,0); word-spacing: 0px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; -webkit-text-decorations-in-effect: none; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px"><a href="/downloads/images/2011_11/IMG_0172.jpg"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="IMG_0172" border="0" alt="IMG_0172" src="/downloads/images/2011_11/IMG_0172.jpg" width="204" height="275" /></a> <a href="/downloads/images/2011_11/IMG_0168.jpg"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="IMG_0168" border="0" alt="IMG_0168" src="/downloads/images/2011_11/IMG_0168.jpg" width="204" height="285" /></a> <a href="/downloads/images/2011_11/IMG_0200.jpg"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="IMG_0200" border="0" alt="IMG_0200" src="/downloads/images/2011_11/IMG_0200.jpg" width="204" height="288" /></a> </span></p>

<p>看这些照片的时候，最大的怀念是以前生活在青山绿水的白水河时，我们一家人那轻松自在的身段。在我们匆忙长大的这二十来年，中国也一直在匆忙的变化着。我们的文艺工作者在世纪之交做过很多牛逼哄哄的选题，什么《激荡三十年》，什么《大国崛起》，妄图把这个剧变的时代描绘成一代人怀着同样的目标，努力奋斗让中国崛起的时代。</p>

<p>而实际上，绝大多数家庭就和我们家一样，我们并没有主动的参与到那些变化里面去。很多人虽然听组织安排上山下乡或者援建支边，但和全国志士要行动起来抛头颅洒热血的革命年代不同，大多数人的生活目标与生存焦虑既无关这个社会，也无关这个国家，都是些极度自我的事情。但这个国家变化得如此剧烈，昨天还有效的经验，明天就可能完全完蛋。所以更多的时候，毫无信仰的中国人无力的忍受着生活剧烈的摇摆，随波逐流的同时，常常感到心灵上莫大的空虚和痛苦。</p>

<p>所以，在过去我曾经为父母和我们生活在不同的世界，或者是他们的婚姻变得危机四伏而苦恼不已。可是等我到了一定年纪就发现原来他们那代人中并没有多少真正快乐的夫妻：他们大多数人，在生活中不断的否定着自己信仰过的东西。要人们在这种奇特的生活环境中保持感情的稳定，也许的确是要求高了一些。</p>

<p>相比之下，我们这代人当然要幸运一些。虽然如果统计一下，应该没有几个人自己长大的老房子还没有被拆。但至少我们留下了不少照片，从感觉上，已经不是那么老无所依。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/13/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/11/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    
  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Lenciel Li<span class="theme-version">Octopress-Lenciel 0.1</span>
  <section class="contruction-wrap">
    <div class="contruction"></div>
  </section>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'lencielgithub';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>









<!--














                                            IIIIIIIIII       I
                  II                     IIIIIIIIIIIIIIIIIIII
                  IIII                  IIIIIIIIIIIIIIIIIIII
                  IIIIII                IIIIIIIIIIIIIIIIII III
                  IIIIIIII             IIIIIIIIIIIIIIIIIIIIII
                  IIIIIIIIIII          IIIIIIIIIIIIIIIIIIIII
                  IIIIIIIIIIIIII       IIIIIIIIIIIIIIIIIII
                   IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                  I  IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                  IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                  IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                   IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                    IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                     IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                         IIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                     IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                      IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                        IIIIIIIIIIIIIIIIIIIIIIIIIIIII
                           IIIIIIIIIIIIIIIIIIIIIIIII
                             IIIIIIIIIIIIIIIIIIIII
                          IIIIIIIIIIIIIIIIIIIIIII
                I   IIIIIIIIIIIIIIIIIIIIIIIIII
                  IIIIIIIIIIIIIIIIIIIIIIIIII
                      IIIIIIIIIIIIIIIIII















 -->


</body>
</html>
