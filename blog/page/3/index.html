
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>@Lenciel</title>
  <meta name="author" content="Lenciel Li">

  
  <meta name="description" content="这周我们的一个项目里面需要调用第三方接口。对方的安全机制是调用时要进行加密和校验，但它们的文档没有描述具体是怎么加密的，而是给了一段代码： 1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://lenciel.github.io/blog/page/3/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/github/lenciel" rel="alternate" title="@Lenciel" type="application/atom+xml">
  <!-- Facebook Open Graph
     Facebook Debugger: https://developers.facebook.com/tools/debug -->

<meta property="og:type" content="article" />
<meta property="og:url" content="http://lenciel.github.io/blog/page/3/" />
<meta property="og:description" content="这周我们的一个项目里面需要调用第三方接口。对方的安全机制是调用时要进行加密和校验，但它们的文档没有描述具体是怎么加密的，而是给了一段代码： 1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29 &hellip;" />

<meta property="og:site_name" content="http://lenciel.github.io" />
<meta property="article:author" content="https://plus.google.com/114787528537231301324">



<meta itemprop="description" content="这周我们的一个项目里面需要调用第三方接口。对方的安全机制是调用时要进行加密和校验，但它们的文档没有描述具体是怎么加密的，而是给了一段代码： 1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29 &hellip;" />

<!-- Combine multiple fonts into one request -->
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic|Patua+One|Yanone+Kaffeesatz" rel="stylesheet" type="text/css">
<!-- jQuery -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-175991-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">@Lenciel</a></h1>
  
    <h2>Thoughts and Rants.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/github/lenciel" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:lenciel.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/"><i class="icon-home"></i>Home</a></li>
  <li><a href="/blog/archives"><i class="icon-book-alt"></i>Archives</a><span class="divider"></span></li>
  <li><a href="/about"><i class="icon-user"></i>About</a><span class="divider"></span></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2013/07/cryptography-and-python/">Cryptography and Python</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-25T15:13:00+08:00" pubdate data-updated="true">Jul 25<span>th</span>, 2013</time>
        
         | <a href="/2013/07/cryptography-and-python/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这周我们的一个项目里面需要调用第三方接口。对方的安全机制是调用时要进行加密和校验，但它们的文档没有描述具体是怎么加密的，而是给了一段代码：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">private</span> <span class="kd">static</span> <span class="n">BASE64Encoder</span> <span class="n">base64</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BASE64Encoder</span><span class="o">();</span>
</span><span class="line"><span class="c1">//  private static byte[] myIV = { 50, 51, 52, 53, 54, 55, 56, 57 };</span>
</span><span class="line"><span class="c1">//  private static byte[] myIV = null;</span>
</span><span class="line"><span class="c1">//  private static String strkey = &quot;W9qPIzjaVGKUp7CKRk/qpCkg/SCMkQRu&quot;; // 字节数必须是8的倍数</span>
</span><span class="line"><span class="c1">//密钥</span>
</span><span class="line"><span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">strkey</span> <span class="o">=</span> <span class="s">&quot;NDg5MDY2NjczMxxxxXXXXXyNzUzNTg2&quot;</span><span class="o">;</span>
</span><span class="line"><span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">removeBR</span><span class="o">(</span><span class="n">String</span> <span class="n">str</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">StringBuffer</span> <span class="n">sf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuffer</span><span class="o">(</span><span class="n">str</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sf</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span>
</span><span class="line">    <span class="o">{</span>
</span><span class="line">      <span class="k">if</span> <span class="o">(</span><span class="n">sf</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="o">)</span>
</span><span class="line">      <span class="o">{</span>
</span><span class="line">        <span class="n">sf</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="na">deleteCharAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sf</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span>
</span><span class="line">    <span class="o">{</span>
</span><span class="line">      <span class="k">if</span> <span class="o">(</span><span class="n">sf</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="o">==</span> <span class="sc">&#39;\r&#39;</span><span class="o">)</span>
</span><span class="line">      <span class="o">{</span>
</span><span class="line">        <span class="n">sf</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="na">deleteCharAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="k">return</span> <span class="n">sf</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">desEncrypt</span><span class="o">(</span><span class="n">String</span> <span class="n">input</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span>
</span><span class="line"><span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="n">BASE64Decoder</span> <span class="n">base64d</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BASE64Decoder</span><span class="o">();</span>
</span><span class="line">    <span class="n">DESedeKeySpec</span> <span class="n">p8ksp</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">    <span class="n">p8ksp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DESedeKeySpec</span><span class="o">(</span><span class="n">base64d</span><span class="o">.</span><span class="na">decodeBuffer</span><span class="o">(</span><span class="n">strkey</span><span class="o">));</span>
</span><span class="line">    <span class="n">Key</span> <span class="n">key</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">    <span class="n">key</span> <span class="o">=</span> <span class="n">SecretKeyFactory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&quot;DESede&quot;</span><span class="o">).</span><span class="na">generateSecret</span><span class="o">(</span><span class="n">p8ksp</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">    <span class="kt">byte</span><span class="o">[]</span> <span class="n">plainBytes</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span><span class="kc">null</span><span class="o">;</span>
</span><span class="line">    <span class="n">Cipher</span> <span class="n">cipher</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">    <span class="kt">byte</span><span class="o">[]</span> <span class="n">cipherText</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span><span class="kc">null</span><span class="o">;</span>
</span><span class="line">    <span class="c1">//“算法/模式/填充”</span>
</span><span class="line">    <span class="n">plainBytes</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="s">&quot;UTF8&quot;</span><span class="o">);</span>
</span><span class="line">    <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&quot;DESede/ECB/PKCS5Padding&quot;</span><span class="o">);</span>
</span><span class="line">    <span class="n">SecretKeySpec</span> <span class="n">myKey</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SecretKeySpec</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">getEncoded</span><span class="o">(),</span> <span class="s">&quot;DESede&quot;</span><span class="o">);</span>
</span><span class="line"> <span class="c1">//       IvParameterSpec ivspec = new IvParameterSpec(myIV);</span>
</span><span class="line">    <span class="n">cipher</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">myKey</span><span class="o">);</span>
</span><span class="line">    <span class="n">cipherText</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="na">doFinal</span><span class="o">(</span><span class="n">plainBytes</span><span class="o">);</span>
</span><span class="line">    <span class="k">return</span> <span class="nf">removeBR</span><span class="o">(</span><span class="n">base64</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">cipherText</span><span class="o">));</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">desDecrypt</span><span class="o">(</span><span class="n">String</span> <span class="n">cipherText</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span>
</span><span class="line"><span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="n">BASE64Decoder</span> <span class="n">base64d</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BASE64Decoder</span><span class="o">();</span>
</span><span class="line">    <span class="n">DESedeKeySpec</span> <span class="n">p8ksp</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">    <span class="n">p8ksp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DESedeKeySpec</span><span class="o">(</span><span class="n">base64d</span><span class="o">.</span><span class="na">decodeBuffer</span><span class="o">(</span><span class="n">strkey</span><span class="o">));</span>
</span><span class="line">    <span class="n">Key</span> <span class="n">key</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">    <span class="n">key</span> <span class="o">=</span> <span class="n">SecretKeyFactory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&quot;DESede&quot;</span><span class="o">).</span><span class="na">generateSecret</span><span class="o">(</span><span class="n">p8ksp</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">    <span class="n">Cipher</span> <span class="n">cipher</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">    <span class="kt">byte</span><span class="o">[]</span> <span class="n">inPut</span> <span class="o">=</span> <span class="n">base64d</span><span class="o">.</span><span class="na">decodeBuffer</span><span class="o">(</span><span class="n">cipherText</span><span class="o">);</span>
</span><span class="line">    <span class="c1">//“算法/模式/填充”</span>
</span><span class="line">    <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&quot;DESede/ECB/PKCS5Padding&quot;</span><span class="o">);</span>
</span><span class="line">    <span class="n">SecretKeySpec</span> <span class="n">myKey</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SecretKeySpec</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">getEncoded</span><span class="o">(),</span> <span class="s">&quot;DESede&quot;</span><span class="o">);</span>
</span><span class="line"> <span class="c1">//       IvParameterSpec ivspec = new IvParameterSpec(myIV);</span>
</span><span class="line">    <span class="n">cipher</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">myKey</span><span class="o">);</span>
</span><span class="line">    <span class="kt">byte</span><span class="o">[]</span> <span class="n">output</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="na">doFinal</span><span class="o">(</span><span class="n">inPut</span><span class="o">);</span>
</span><span class="line">    <span class="k">return</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">output</span><span class="o">,</span> <span class="s">&quot;UTF8&quot;</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>很明显，在提供文档的同学看来大家都是JEE程序员。仔细看了半天这两个函数<code>desEncrypt</code>和<code>desDecrypt</code>外加Google，才明白是<code>DES3</code>算法。</p>

<p>接着这份文档的后面还有另一个对加密的描述也是代码，不过这次比较明显是MD5：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="nf">MD5</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span>
</span><span class="line"><span class="o">{</span>
</span><span class="line">  <span class="kt">char</span> <span class="n">hexDigits</span><span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="sc">&#39;0&#39;</span><span class="o">,</span> <span class="sc">&#39;1&#39;</span><span class="o">,</span> <span class="sc">&#39;2&#39;</span><span class="o">,</span> <span class="sc">&#39;3&#39;</span><span class="o">,</span> <span class="sc">&#39;4&#39;</span><span class="o">,</span> <span class="sc">&#39;5&#39;</span><span class="o">,</span> <span class="sc">&#39;6&#39;</span><span class="o">,</span> <span class="sc">&#39;7&#39;</span><span class="o">,</span> <span class="sc">&#39;8&#39;</span><span class="o">,</span> <span class="sc">&#39;9&#39;</span><span class="o">,</span>
</span><span class="line">    <span class="sc">&#39;a&#39;</span><span class="o">,</span> <span class="sc">&#39;b&#39;</span><span class="o">,</span> <span class="sc">&#39;c&#39;</span><span class="o">,</span> <span class="sc">&#39;d&#39;</span><span class="o">,</span> <span class="sc">&#39;e&#39;</span><span class="o">,</span> <span class="sc">&#39;f&#39;</span>
</span><span class="line">    <span class="o">};</span>
</span><span class="line">  <span class="kt">char</span> <span class="n">str</span><span class="o">[]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">  <span class="kt">byte</span> <span class="n">strTemp</span><span class="o">[]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
</span><span class="line">  <span class="n">MessageDigest</span> <span class="n">mdTemp</span><span class="o">;</span>
</span><span class="line">  <span class="k">try</span> <span class="o">{</span>
</span><span class="line">    <span class="n">mdTemp</span> <span class="o">=</span> <span class="n">MessageDigest</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&quot;MD5&quot;</span><span class="o">);</span>
</span><span class="line">    <span class="n">mdTemp</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">strTemp</span><span class="o">);</span>
</span><span class="line">    <span class="kt">byte</span> <span class="n">md</span><span class="o">[]</span> <span class="o">=</span> <span class="n">mdTemp</span><span class="o">.</span><span class="na">digest</span><span class="o">();</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
</span><span class="line">    <span class="n">str</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="o">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">2</span><span class="o">];</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class="line">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
</span><span class="line">    <span class="o">{</span>
</span><span class="line">      <span class="kt">byte</span> <span class="n">b</span> <span class="o">=</span> <span class="n">md</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span><span class="line">      <span class="n">str</span><span class="o">[</span><span class="n">k</span><span class="o">++]</span> <span class="o">=</span> <span class="n">hexDigits</span><span class="o">[</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="o">];</span>
</span><span class="line">      <span class="n">str</span><span class="o">[</span><span class="n">k</span><span class="o">++]</span> <span class="o">=</span> <span class="n">hexDigits</span><span class="o">[</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="o">];</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchAlgorithmException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="c1">// TODO Auto-generated catch block</span>
</span><span class="line">    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">return</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">str</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>这些算法用python来实现当然就简单多了:MD5就是一句话，看起来非常复杂的DES3也不过几句话:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">pyDes</span> <span class="kn">import</span> <span class="n">triple_des</span><span class="p">,</span> <span class="n">ECB</span><span class="p">,</span> <span class="n">PAD_PKCS5</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">base64</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">datetime</span>
</span><span class="line">
</span><span class="line"><span class="n">input_str</span> <span class="o">=</span> <span class="s">&quot;test string&quot;</span>
</span><span class="line">
</span><span class="line"><span class="n">key_base64_str</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="s">&quot;NDg5MDY2NjczMxxxxXXXXXyNzUzNTg2&quot;</span><span class="p">,</span> <span class="s">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span class="line"><span class="n">key_bytes</span> <span class="o">=</span> <span class="n">key_base64_str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
</span><span class="line"><span class="n">k</span> <span class="o">=</span> <span class="n">triple_des</span><span class="p">(</span><span class="n">key_bytes</span><span class="p">,</span> <span class="n">ECB</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">padmode</span><span class="o">=</span><span class="n">PAD_PKCS5</span><span class="p">)</span>
</span><span class="line"><span class="n">d</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">input_str</span><span class="p">))</span>
</span><span class="line"><span class="k">print</span> <span class="n">d</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>当然，要明白这些算法究竟怎么回事才叫认真负责的态度。</p>

<h2 id="hash"><strong>Hash</strong></h2>

<p>hash就是给输入的字符串生成一个固定长度的字符串（被称为hash值）。理想的hash要满足：</p>

<ul>
  <li>根据生成的字符串非常难猜到输入的字符串</li>
  <li>任意两个不同的字符串不会生成相同的hash值</li>
  <li>如果输入字符串没有变生成的hash值应该不会变</li>
</ul>

<p><img src="/downloads/images/hash.png" alt="hash" title="Don't touch me..." /></p>

<p>hash函数可以被用来计算checksum，也可以用来进行数字签名和认证。</p>

<h3 id="md5"><strong>MD5</strong></h3>

<p>1991年面世的一种hash算法，生成的字符串长度为128bit。</p>

<p>它的算法详情可以看<a href="http://tools.ietf.org/html/rfc1321">这里</a>，简单说如下：</p>

<ul>
  <li>首先需要对字符串进行扩展，使其位长对512求余的结果等于448。因此，位长（Bits Length）将被扩展至N*512+448，N为一个非负整数，N可以是零。填充的方法一般是在信息的后面填充一个1和无数个0，直到满足上面的条件时才停止用0对信息的填充。</li>
  <li>然后，在这个结果后面附加一个以64位二进制表示的填充前信息长度。经过这两步的处理，现在的位长是 <code>N*512+448+64 = (N+1）*512</code>，即长度恰好是512的整数倍。</li>
  <li>最后以512位分组来处理输入的信息，且每一分组又被划分为16个32位子分组，经过了一系列的处理后，算法的输出由四个32位分组组成，将这四个32位分组级联后将生成一个128位散列值。</li>
</ul>

<p>MD5对碰撞攻击(不同的输入生成相同的hash)等攻击的抵抗力比较差。</p>

<p>在python中使用MD5:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">os</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">Crypto.Hash</span> <span class="kn">import</span> <span class="n">MD5</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">get_file_checksum</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
</span><span class="line">    <span class="n">h</span> <span class="o">=</span> <span class="n">MD5</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
</span><span class="line">    <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">8192</span>
</span><span class="line">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span class="line">        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class="line">            <span class="n">chunk</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">)</span>
</span><span class="line">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class="line">                <span class="k">break</span>
</span><span class="line">            <span class="n">h</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
</span><span class="line">    <span class="k">return</span> <span class="n">h</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="section"><strong>加密算法</strong></h2>

<p>加密算法使用key把输入的文本变成加密的文本。有两种加密的方式：分块和流。分块处理的单位是固定大小比如8或者16个bytes，流则是一个一个byte。只有知道了解密的<code>key</code>才能对加密的文本进行解密。</p>

<h3 id="section-1"><em>分块</em></h3>

<p>DES是分块加密的一种，其处理对象的大小是8个bytes。DES最简单的模式是所谓的<code>ECB( electronic code book)模式</code>，也就是每个block都是独立加密，最后组成整个加密后的文本。</p>

<p><img src="/downloads/images/block_cipher_ebc.png" alt="ecb" title="Don't touch me..." /></p>

<p>使用pycrpto对文本使用<code>DES/ECB</code>加密很简单。假设key是<code>10234567</code>，而我们要加密的文本是<code>abcdefgh</code>，那么：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">DES</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">des</span> <span class="o">=</span> <span class="n">DES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s">&#39;01234567&#39;</span><span class="p">,</span> <span class="n">DES</span><span class="o">.</span><span class="n">MODE_ECB</span><span class="p">)</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">text</span> <span class="o">=</span> <span class="s">&#39;abcdefgh&#39;</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">cipher_text</span> <span class="o">=</span> <span class="n">des</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">cipher_text</span>
</span><span class="line"><span class="s">&#39;</span><span class="se">\xec\xc2\x9e\xd9</span><span class="s">] a</span><span class="se">\xd0</span><span class="s">&#39;</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">des</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">cipher_text</span><span class="p">)</span>
</span><span class="line"><span class="s">&#39;abcdefgh&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>比<code>ECB</code>更健壮的是<code>CFB (Cipher feedback)</code>模式，也就是先组合前面加密的文本和待加密的文本，然后进行加密。</p>

<p><img src="/downloads/images/block_cipher_cfb.png" alt="cfb" title="Don't touch me..." /></p>

<p>下面的例子说明了算法的工作流程：待加密的是<code>abcdefghijklmnop</code>，两倍8bytes。首先生成一个随机的字符串作为初始的<code>iv</code>来生成两个<code>DES</code>对象，一个用来加密一个用来解密。之所以需要这两个对象，是因为<code>feedback</code>值会随着block被加密后变化。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">DES</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">Crypto</span> <span class="kn">import</span> <span class="n">Random</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">iv</span> <span class="o">=</span> <span class="n">Random</span><span class="o">.</span><span class="n">get_random_bytes</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">des1</span> <span class="o">=</span> <span class="n">DES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s">&#39;01234567&#39;</span><span class="p">,</span> <span class="n">DES</span><span class="o">.</span><span class="n">MODE_CFB</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">des2</span> <span class="o">=</span> <span class="n">DES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s">&#39;01234567&#39;</span><span class="p">,</span> <span class="n">DES</span><span class="o">.</span><span class="n">MODE_CFB</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">text</span> <span class="o">=</span> <span class="s">&#39;abcdefghijklmnop&#39;</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">cipher_text</span> <span class="o">=</span> <span class="n">des1</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">cipher_text</span>
</span><span class="line"><span class="s">&quot;?</span><span class="se">\\\x8e\x86\xeb\xab\x8b\x97</span><span class="s">&#39;</span><span class="se">\xa1</span><span class="s">W</span><span class="se">\xde\x89</span><span class="s">!</span><span class="se">\xc3</span><span class="s">d&quot;</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">des2</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">cipher_text</span><span class="p">)</span>
</span><span class="line"><span class="s">&#39;abcdefghijklmnop&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-2"><em>流</em></h3>

<p>这些算法基于一个个bytes，所以block的大小总是1 byte。pycrypto提供了两个这样的算法：<code>ARC4</code> 和 <code>XOR</code>。这种基于流的算法只有一种模式：<code>ECB</code>。</p>

<p>下面是一个<code>ARC4</code>的算法，使用了key <code>01234567</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">ARC4</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">obj1</span> <span class="o">=</span> <span class="n">ARC4</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s">&#39;01234567&#39;</span><span class="p">)</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">obj2</span> <span class="o">=</span> <span class="n">ARC4</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s">&#39;01234567&#39;</span><span class="p">)</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">text</span> <span class="o">=</span> <span class="s">&#39;abcdefghijklmnop&#39;</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">cipher_text</span> <span class="o">=</span> <span class="n">obj1</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">cipher_text</span>
</span><span class="line"><span class="s">&#39;</span><span class="se">\xf0\xb7\x90</span><span class="s">{#ABXY9</span><span class="se">\xd0</span><span class="s">6</span><span class="se">\x9f\xc0\x8c</span><span class="s"> &#39;</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">obj2</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">cipher_text</span><span class="p">)</span>
</span><span class="line"><span class="s">&#39;abcdefghijklmnop&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-3"><strong>应用程序</strong></h3>

<p>在程序里面我们常常使用DES3对文件进行加密解密操作。一般来说操作对象是文件时，总是分成一个个chunck来处理以免占用太多内存。如果读入的chunck少于16bytes，就需要扩展它才能进行加密。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">os</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">DES3</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">encrypt_file</span><span class="p">(</span><span class="n">in_filename</span><span class="p">,</span> <span class="n">out_filename</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">iv</span><span class="p">):</span>
</span><span class="line">    <span class="n">des3</span> <span class="o">=</span> <span class="n">DES3</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">DES3</span><span class="o">.</span><span class="n">MODE_CFB</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">in_filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_file</span><span class="p">:</span>
</span><span class="line">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file</span><span class="p">:</span>
</span><span class="line">            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class="line">                <span class="n">chunk</span> <span class="o">=</span> <span class="n">in_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">)</span>
</span><span class="line">                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class="line">                    <span class="k">break</span>
</span><span class="line">                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span class="line">                    <span class="n">chunk</span> <span class="o">+=</span> <span class="s">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span>
</span><span class="line">                <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">des3</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">decrypt_file</span><span class="p">(</span><span class="n">in_filename</span><span class="p">,</span> <span class="n">out_filename</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">iv</span><span class="p">):</span>
</span><span class="line">    <span class="n">des3</span> <span class="o">=</span> <span class="n">DES3</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">DES3</span><span class="o">.</span><span class="n">MODE_CFB</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">in_filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_file</span><span class="p">:</span>
</span><span class="line">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file</span><span class="p">:</span>
</span><span class="line">            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class="line">                <span class="n">chunk</span> <span class="o">=</span> <span class="n">in_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">)</span>
</span><span class="line">                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class="line">                    <span class="k">break</span>
</span><span class="line">                <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">des3</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>有了上面定义的这两个函数我们可以这样使用它们：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">Crypto</span> <span class="kn">import</span> <span class="n">Random</span>
</span><span class="line"><span class="n">iv</span> <span class="o">=</span> <span class="n">Random</span><span class="o">.</span><span class="n">get_random_bytes</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</span><span class="line"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;to_enc.txt&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span class="line">    <span class="k">print</span> <span class="s">&#39;to_enc.txt: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span class="line"><span class="n">encrypt_file</span><span class="p">(</span><span class="s">&#39;to_enc.txt&#39;</span><span class="p">,</span> <span class="s">&#39;to_enc.enc&#39;</span><span class="p">,</span> <span class="mi">8192</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
</span><span class="line"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;to_enc.enc&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span class="line">    <span class="k">print</span> <span class="s">&#39;to_enc.enc: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span class="line"><span class="n">decrypt_file</span><span class="p">(</span><span class="s">&#39;to_enc.enc&#39;</span><span class="p">,</span> <span class="s">&#39;to_enc.dec&#39;</span><span class="p">,</span> <span class="mi">8192</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
</span><span class="line"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;to_enc.dec&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span class="line">    <span class="k">print</span> <span class="s">&#39;to_enc.dec: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>程序的输出如下：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">to_enc.txt: this content needs to be encrypted.
</span><span class="line">
</span><span class="line">to_enc.enc: ??~?E??.??<span class="o">]</span>!<span class="o">=)</span>??<span class="err">&quot;</span>t?
</span><span class="line">                                JpDw???R?UN0?<span class="o">=</span>??R?UN0?<span class="o">}</span>0r?FV9
</span><span class="line">to_enc.dec: this content needs to be encrypted.
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="public-key-algorithms"><strong>Public-key algorithms</strong></h2>

<p>上面提到的加密算法的一大问题是双方都需要知道key。而<code>public-key算法</code>提供了两个key，一个用来加密，一个用来解密。 </p>

<p><img src="/downloads/images/public_private_key.png" alt="ecb" title="Don't touch me..." /></p>

<h3 id="publicprivate-key"><strong>public/private key</strong></h3>

<p>使用pycrpto很容易就可以生成一对<code>private/public key</code>，生成key的时候必须规定key的长度，越长越安全。除开长度，还需要设定生成key的方法。下面是一个使用RSA生成1024bit长度key的过程：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">Crypto.PublicKey</span> <span class="kn">import</span> <span class="n">RSA</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">Crypto</span> <span class="kn">import</span> <span class="n">Random</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">random_generator</span> <span class="o">=</span> <span class="n">Random</span><span class="o">.</span><span class="n">new</span><span class="p">()</span><span class="o">.</span><span class="n">read</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">key</span> <span class="o">=</span> <span class="n">RSA</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">random_generator</span><span class="p">)</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">key</span>
</span><span class="line"><span class="o">&lt;</span><span class="n">_RSAobj</span> <span class="nd">@0x7f60cf1b57e8</span> <span class="n">n</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span><span class="n">e</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">private</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>key对象有一系列的方法：
- <code>can_encrypt()</code> 返回是否能用key来加密数据 
- <code>can_sign()</code> 返回是否能用key来进行签名
- <code>has_private()</code> 返回是否有private key</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">key</span><span class="o">.</span><span class="n">can_encrypt</span><span class="p">()</span>
</span><span class="line"><span class="bp">True</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">key</span><span class="o">.</span><span class="n">can_sign</span><span class="p">()</span>
</span><span class="line"><span class="bp">True</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">key</span><span class="o">.</span><span class="n">has_private</span><span class="p">()</span>
</span><span class="line"><span class="bp">True</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-4"><strong>加密</strong></h3>

<p>现在我们有了一对key，我们就可以加密一些数据了。加密的时候使用的是公钥: <code>public key</code> ：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">public_key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">publickey</span><span class="p">()</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">enc_data</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="s">&#39;abcdefgh&#39;</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">enc_data</span>
</span><span class="line"><span class="p">(</span><span class="s">&#39;</span><span class="se">\x11\x86\x8b\xfa\x82\xdf\xe3</span><span class="s">sN ~@</span><span class="se">\xdb</span><span class="s">P</span><span class="se">\x85</span>
</span><span class="line">\<span class="n">x93</span>\<span class="n">xe6</span>\<span class="n">xb9</span>\<span class="n">xe9</span>\<span class="n">x95I</span>\<span class="n">xa7</span>\<span class="n">xadQ</span>\<span class="n">x08</span>\<span class="n">xe5</span>\<span class="n">xc8</span><span class="err">$</span><span class="mi">9</span>\<span class="n">x81K</span>\<span class="n">xa0</span>\<span class="n">xb5</span>\<span class="n">xee</span>\<span class="n">x1e</span>\<span class="n">xb5r</span>
</span><span class="line">\<span class="n">x9bH</span><span class="p">)</span>\<span class="n">xd8</span>\<span class="n">xeb</span>\<span class="n">x03</span>\<span class="n">xf3</span>\<span class="n">x86</span>\<span class="n">xb5</span>\<span class="n">x03</span>\<span class="n">xfd</span>\<span class="n">x97</span>\<span class="n">xe6</span><span class="o">%</span>\<span class="n">x9e</span>\<span class="n">xf7</span>\<span class="n">x11</span><span class="o">=</span>\<span class="n">xa1Y</span><span class="o">&lt;</span>\<span class="n">xdc</span>
</span><span class="line">\<span class="n">x94</span>\<span class="n">xf0</span>\<span class="n">x7f7</span><span class="err">@</span>\<span class="n">x9c</span>\<span class="n">x02suc</span>\<span class="n">xcc</span>\<span class="n">xc2j</span>\<span class="n">x0c</span>\<span class="n">xce</span>\<span class="n">x92</span>\<span class="n">x8d</span>\<span class="n">xdc</span>\<span class="n">x00uL</span>\<span class="n">xd6</span><span class="o">.</span>
</span><span class="line">\<span class="n">x84</span><span class="o">~/</span>\<span class="n">xed</span>\<span class="n">xd7</span>\<span class="n">xc5</span>\<span class="n">xbe</span>\<span class="n">xd2</span>\<span class="n">x98</span>\<span class="n">xec</span>\<span class="n">xe4</span>\<span class="n">xda</span>\<span class="n">xd1L</span>\<span class="n">rM</span><span class="err">`</span>\<span class="n">x88</span>\<span class="n">x13V</span>\<span class="n">xe1M</span>\<span class="n">n</span> <span class="n">X</span>
</span><span class="line">\<span class="n">xce</span>\<span class="n">x13</span> \<span class="n">xaf</span>\<span class="n">x10</span><span class="o">|</span>\<span class="n">x80</span>\<span class="n">x0e</span>\<span class="n">x14</span>\<span class="n">xbc</span>\<span class="n">x14</span>\<span class="n">x1ec</span>\<span class="n">xf6Rs</span>\<span class="n">xbb</span>\<span class="n">x93</span>\<span class="n">x06</span>\<span class="n">xbe</span><span class="s">&#39;,)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-5"><strong>解密</strong></h3>

<p>只要有用于解密的私钥(private key)解密是很简单的：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">key</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">enc_data</span><span class="p">)</span>
</span><span class="line"><span class="s">&#39;abcdefgh&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-6"><strong>签名</strong></h3>

<p>对信息进行签名，可以用来验证信息的作者，让我们相信它的来源。下面这个例子展示了如何先算出信息的hash值，然后送给RSA key的<code>sign()</code>方法。使用其他算法如<code>DSA</code>或者是<code>ElGamal</code>也类似。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">Crypto.Hash</span> <span class="kn">import</span> <span class="n">MD5</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">Crypto.PublicKey</span> <span class="kn">import</span> <span class="n">RSA</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">Crypto</span> <span class="kn">import</span> <span class="n">Random</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">key</span> <span class="o">=</span> <span class="n">RSA</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">random_generator</span><span class="p">)</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">text</span> <span class="o">=</span> <span class="s">&#39;abcdefgh&#39;</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="nb">hash</span> <span class="o">=</span> <span class="n">MD5</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="nb">hash</span>
</span><span class="line"><span class="s">&#39;</span><span class="se">\xe8\xdc</span><span class="s">@</span><span class="se">\x81\xb1</span><span class="s">44</span><span class="se">\xb4</span><span class="s">Q</span><span class="se">\x89\xa7</span><span class="s"> </span><span class="se">\xb7</span><span class="s">{h</span><span class="se">\x18</span><span class="s">&#39;</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">signature</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">signature</span>
</span><span class="line"><span class="p">(</span><span class="mi">1549358700992033008647390368952919655009213441715588267926189797</span>
</span><span class="line"><span class="mi">14352832388210003027089995136141364041133696073722879839526120115</span>
</span><span class="line"><span class="mi">25996986614087200336035744524518268136542404418603981729787438986</span>
</span><span class="line"><span class="mi">50177007820700181992412437228386361134849096112920177007759309019</span>
</span><span class="line"><span class="il">6400328917297225219942913552938646767912958849053L</span><span class="p">,)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="section-7"><strong>验证</strong></h3>

<p>只要有公钥，验证信息就很简单了。未加密的文本和签名一起被发送给接收方。接收方计算hash值然后调用公钥的<code>verify()</code>方法来进行验证：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">text</span> <span class="o">=</span> <span class="s">&#39;abcdefgh&#39;</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="nb">hash</span> <span class="o">=</span> <span class="n">MD5</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
</span><span class="line"><span class="o">&gt;&gt;&gt;</span> <span class="n">public_key</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="nb">hash</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span>
</span><span class="line"><span class="bp">True</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2013/07/doomsday-machines/">Doomsday Machines</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-23T23:25:00+08:00" pubdate data-updated="true">Jul 23<span>rd</span>, 2013</time>
        
         | <a href="/2013/07/doomsday-machines/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="/downloads/images/dr_strangelove_doomsday_machine.gif" alt="doomsday machines" title="Don't touch me..." /></p>

<blockquote><p>Gee, I wish we had one of them doomsday machines.</p><footer><strong>Stanley Kubrick</strong> <cite><a href="http://www.imdb.com/title/tt0057012/">Fight Dr. Strangelove or: How I Learned to Stop Worrying and Love the Bomb(1964)</a></cite></footer></blockquote>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2013/07/stop-specific-zsh-shell-auto-correct/">关掉Zsh对指定命令的自动纠错</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-23T14:47:00+08:00" pubdate data-updated="true">Jul 23<span>rd</span>, 2013</time>
        
         | <a href="/2013/07/stop-specific-zsh-shell-auto-correct/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>工作机器切换到Mac之后我一直在自用并在团队中推广 <a href="https://github.com/lenciel/oh-my-zsh"><code>oh-my-zsh</code></a>。99%的时间本座对它是如此满意，除开有的时候它的服务太主动了一些。</p>

<p>比如今天在用<code>curl</code>试用一个接口的时候，我测试用的payload放在一个<code>payload.json</code>文件里面，所以命令是：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">curl -H "Content-Type: application/json" -X POST -d @payload.json  http://xxx.xxx.xxx/xxx/StartServiceServlet</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>然后它就一直提示：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">zsh: correct '@payload.json' to 'payload.json' [nyae]?</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>一，直，提，示。</p>

<p>跑到代码里面去看了一下，要关掉这种自动纠错的提示可以配置 <code>~/.oh-my-zsh/lib/correction.zsh</code>：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">alias curl='nocorrect curl'</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>整个世界清静了…</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2013/07/we-are-men/">We Are Men</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-22T21:24:00+08:00" pubdate data-updated="true">Jul 22<span>nd</span>, 2013</time>
        
         | <a href="/2013/07/we-are-men/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="/downloads/images/fight_club.gif" alt="we are men" title="Don't touch me..." /></p>

<blockquote><p>Yes, we’re men. Men is what we are.</p><footer><strong>Palahniuk</strong> <cite><a href="http://en.wikipedia.org/wiki/Fight_Club">Fight Club(1999)</a></cite></footer></blockquote>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2013/07/oauth-introduction-and-tips/">Oauth: Introduction and Tips</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-22T09:53:00+08:00" pubdate data-updated="true">Jul 22<span>nd</span>, 2013</time>
        
         | <a href="/2013/07/oauth-introduction-and-tips/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><ul id="markdown-toc">
  <li><a href="#table-of-contents">Table Of Contents</a>    <ul>
      <li><a href="#terminology--reference">Terminology / Reference</a>        <ul>
          <li><a href="#signed-requests">Signed Requests</a>            <ul>
              <li><a href="#signature-base-string">Signature Base String</a>                <ul>
                  <li><a href="#signing-key">Signing Key</a></li>
                </ul>
              </li>
              <li><a href="#signature">Signature编码</a>                <ul>
                  <li><a href="#plaintext">PLAINTEXT</a></li>
                  <li><a href="#hmac-sha1">HMAC-SHA1</a></li>
                  <li><a href="#rsa-sha1">RSA-SHA1</a></li>
                </ul>
              </li>
              <li><a href="#oauth">OAuth请求头</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#oauth-10a-one-legged">OAuth 1.0a (one-legged)</a></li>
      <li><a href="#oauth-10a-two-legged">OAuth 1.0a (two-legged)</a></li>
      <li><a href="#oauth-10a-three-legged">OAuth 1.0a (three-legged)</a></li>
      <li><a href="#oauth-10a-echo">OAuth 1.0a (Echo)</a></li>
      <li><a href="#oauth-10a-xauth">OAuth 1.0a (xAuth)</a></li>
      <li><a href="#oauth-2-two-legged">OAuth 2 (two-legged)</a>        <ul>
          <li><a href="#client-credentials">Client Credentials</a></li>
          <li><a href="#resource-owner-password">Resource Owner Password</a></li>
        </ul>
      </li>
      <li><a href="#oauth-2-three-legged">OAuth 2 (three-legged)</a></li>
      <li><a href="#oauth-2-refresh-token">OAuth 2 (refresh token)</a></li>
      <li><a href="#tips--tricks">Tips &amp; Tricks</a>        <ul>
          <li><a href="#access-tokenrefresh-key">生成Access Token和Refresh Key</a>            <ul>
              <li><a href="#section">例子</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#references">References</a></li>
    </ul>
  </li>
</ul>

<h1 id="table-of-contents">Table Of Contents</h1>

<h2 id="terminology--reference">Terminology / Reference</h2>

<ul>
  <li>Signed / Signature
    <ul>
      <li>由一系列的HTTP request元素组成的一个字符串。</li>
    </ul>

    <p>这里说的HTTP request元素一般包括了<code>Request Method</code> <code>&amp;</code> <code>URL Query</code> <code>&amp;</code> <code>Parameters</code>, 并且这些元素用(<code>consumer_secret</code> <code>&amp;</code> <code>token_secret</code>)组成的key进行了加密。In some cases this may be the key, plaintext, or may use simply the <code>consumer_secret</code>, for RSA encryption.</p>
  </li>
  <li>Consumer Secret
    <ul>
      <li>由应用提供出来作为OAuth握手的保密的token</li>
    </ul>
  </li>
  <li>Consumer Key
    <ul>
      <li>由应用随Consumer Secret一起提供，用来做OAuth的握手的key</li>
    </ul>
  </li>
  <li>Nonce / UID
    <ul>
      <li>通常<code>32</code>个字符长度，由<code>a-zA-Z0-9</code>中的字符生成的一个独一无二的ID</li>
    </ul>
  </li>
  <li>OAuth Token
    <ul>
      <li>由服务器或者是其他Endpoint发送的，用来作为Request或者Access的token</li>
    </ul>
  </li>
  <li>OAuth Token Secret
    <ul>
      <li>作为特定token的响应被发送，用来进行 <code>exchanges / refreshing</code>.</li>
    </ul>
  </li>
  <li>Query
    <ul>
      <li>URL中的用 <code>?</code> 符号隔开的一些键值对部分。键和值之间用 <code>=</code> 分隔，例如 <code>?query=looks&amp;like=this</code></li>
    </ul>
  </li>
  <li>Parameter / Argument
    <ul>
      <li>一般指Query中的键，比如 <code>oauth_token="helloWorld"</code> 中 <code>oauth_token</code> 被称为一个 <code>parameter</code> 或者 <code>argument</code> 而 <code>helloWorld</code> 则是它的值。</li>
    </ul>
  </li>
  <li>PLAINTEXT
    <ul>
      <li>使用普通文本作为Signature的保存方式</li>
    </ul>
  </li>
  <li>HMAC-SHA1 <sup id="fnref:8"><a href="#fn:8" rel="footnote">1</a></sup>
    <ul>
      <li>Signature的保存方式，基于Secure Hash Algorithm(1)，是加密的文本</li>
    </ul>
  </li>
  <li>RSA-SHA1 <sup id="fnref:9"><a href="#fn:9" rel="footnote">2</a></sup>
    <ul>
      <li>Signature的保存方式，基于Secure Hash Algorithm(1)，由一对public/ private的key组成。</li>
    </ul>
  </li>
  <li>Service
    <ul>
      <li>服务方指信息的提供者，在OAuth语境中，Facebook/Twitter/腾讯/新浪等就是一个个的Service</li>
    </ul>
  </li>
  <li>Signature Method
    <ul>
      <li>OAuth接受的加密算法，包括: PLAINTEXT, HMAC-SHA1和RSA-SHA1</li>
    </ul>
  </li>
  <li>Value
    <ul>
      <li>键值对中的值</li>
    </ul>
  </li>
  <li>URL / URI
    <ul>
      <li>URL是URI的一种，你应该懂的吧</li>
    </ul>
  </li>
</ul>

<h3 id="signed-requests">Signed Requests</h3>

<blockquote>
  <p>本章描述的是OAuth 1.0</p>
</blockquote>

<p>对request签名(Sign)是非常重要的，本章主要解释签名流程和各个参数的作用。从数据流上来说，签名的过程就是把应用所获取和所生成的信息放到一个地方去：可以是通过 <code>OAuth</code> 头，也可以是 <code>Query</code> 字符串。</p>

<h4 id="signature-base-string">Signature Base String</h4>

<p>签名的基本组成有：request的 <code>Method</code>，request的 <code>URL</code> (如果是 <code>OAuth Echo</code>则是 <code>credentials uri</code>) 和 request的 <code>Query String</code>。没有加密前它看起来会是下面这样 (例子来自 <a href="https://dev.twitter.com/docs/auth/creating-signature">twitter</a>):</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">POST&amp;https%3A%2F%2Fapi.twitter.com%2F1%2Fstatuses%2Fupdate.json&amp;include_entities%3Dtrue%26oauth_consumer_key%3Dxvz1evFS4wEEPTGEFPHBog%26oauth_nonce%3DkYjzVBB8Y0ZFabxSWbWovY3uYSQ2pTgmZeNu2VS4cg%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1318622958%26oauth_token%3D370773112-GmHxMAgYyLbNEtIKZeRNFsMKPR9EyMZeS9weJAEb%26oauth_version%3D1.0%26status%3DHello%2520Ladies%2520%252B%2520Gentlemen%252C%2520a%2520signed%2520OAuth%2520request%2521</span></code></pre></td></tr></table></div></figure></notextile></div>

<h5 id="signing-key">Signing Key</h5>

<p>上面的 <code>signature base</code> 字符串会被加密。加密时用到的key就是 <em>signing key</em> ， 是由OAuth <code>Consumer Secret</code> 和 <code>Token Secret</code> 用 <code>&amp;</code> 字符连接起来组成的:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">kAcSOqF21Fu85e7zjz7ZN2U4ZRhfV3WpwPAoE3Z7kBw&amp;LswwdoUaIvS8ltyTt5jkRh4J50vUPVVHtR2YPi5kE</span></code></pre></td></tr></table></div></figure></notextile></div>

<hr />

<p><strong>Note:</strong> 如果是使用RSA或者xAuth， <code>signing key</code> 可能只有 <code>Consumer Secret</code> 部分外加一个可以省略的 <code>&amp;</code> 。 更多相关信息可以从mashape-oauth/lib/oauth.js的 <a href="https://github.com/Mashape/mashape-oauth/blob/master/lib/oauth.js#L233">233</a>行和 <a href="https://github.com/Mashape/mashape-oauth/blob/master/lib/oauth.js#L238">238</a>行了解。</p>

<hr />

<h4 id="signature">Signature编码</h4>

<p>有了 <code>signature base string</code> 和 <code>signature key</code> 之后，就需要从这两个字符串中提取信息完成编码。编码的方式共有三种：PLAINTEXT, HMAC, 或者是 RSA。</p>

<h5 id="plaintext">PLAINTEXT</h5>

<p>没有任何编码，直接传 <code>Signature Key</code></p>

<h5 id="hmac-sha1">HMAC-SHA1</h5>

<p>这种编码方式下，二进制格式的key被用来更新base，然后被编码成 <code>Base64</code> 放到<code>signature string</code>里面：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">tnnArxj06cWHq44gCs1OSKk/jLY=</span></code></pre></td></tr></table></div></figure></notextile></div>

<h5 id="rsa-sha1">RSA-SHA1</h5>

<p>这种更复杂但是更安全的方式是根据<code>Signature Base</code>来生成一对<code>private key</code>和<code>public key</code>进行加密。</p>

<p>然后在服务端，会用key来验证编码后的 <code>oauth_signature</code> 字段。</p>

<p><strong>Note:</strong> mashape-oauth/tests/oauth.js的第<a href="https://github.com/Mashape/mashape-oauth/blob/master/tests/oauth.js#L74">74</a>行说明了如何使用生成的<code>private key</code>来对<code>signature base</code>进行编码。</p>

<h4 id="oauth">OAuth请求头</h4>

<p>OAuth请求头包括了<code>oauth_signature</code> 和 <code>oauth_signature_method</code> 等参数及值。这些<code>oauth_*</code> 参数一般会用名字和其他<a href="https://github.com/Mashape/mashape-oauth/blob/master/lib/oauth.js#L111">复杂的规则</a>排序，相互之间用 <code>,</code> 或者是空格分隔。下面是一个取得Twitter的Request Token的例子:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="http"><span class="line"><span class="nf">POST</span> <span class="nn">/oauth/request_token</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span><span class="line"><span class="na">User-Agent</span><span class="o">:</span> <span class="l">themattharris&#39; HTTP Client</span>
</span><span class="line"><span class="na">Host</span><span class="o">:</span> <span class="l">api.twitter.com</span>
</span><span class="line"><span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
</span><span class="line"><span class="err">Authorization:</span>
</span><span class="line">        OAuth oauth_callback=&quot;http%3A%2F%2Flocalhost%2Fsign-in-with-twitter%2F&quot;,
</span><span class="line">              oauth_consumer_key=&quot;cChZNFj6T5R0TigYB9yd1w&quot;,
</span><span class="line">              oauth_nonce=&quot;ea9ec8429b68d6b77cd5600adbbb0456&quot;,
</span><span class="line">              oauth_signature=&quot;F1Li3tvehgcraF8DMJ7OyxO4w9Y%3D&quot;,
</span><span class="line">              oauth_signature_method=&quot;HMAC-SHA1&quot;,
</span><span class="line">              oauth_timestamp=&quot;1318467427&quot;,
</span><span class="line">              oauth_version=&quot;1.0&quot;
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><code>oauth_callback</code> 是整个认证过程完毕后的回调地址，默认情况下服务方会提供一个 <code>oauth_callback_confirmed</code> token。</p>

<p>下面是一个<code>response</code>的例子：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="http"><span class="line"><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
</span><span class="line"><span class="na">Date</span><span class="o">:</span> <span class="l">Thu, 13 Oct 2011 00:57:06 GMT</span>
</span><span class="line"><span class="na">Status</span><span class="o">:</span> <span class="l">200 OK</span>
</span><span class="line"><span class="na">Content-Type</span><span class="o">:</span> <span class="l">text/html; charset=utf-8</span>
</span><span class="line"><span class="na">Content-Length</span><span class="o">:</span> <span class="l">146</span>
</span><span class="line"><span class="na">Pragma</span><span class="o">:</span> <span class="l">no-cache</span>
</span><span class="line"><span class="na">Expires</span><span class="o">:</span> <span class="l">Tue, 31 Mar 1981 05:00:00 GMT</span>
</span><span class="line"><span class="na">Cache-Control</span><span class="o">:</span> <span class="l">no-cache, no-store, must-revalidate, pre-check=0, post-check=0</span>
</span><span class="line"><span class="na">Vary</span><span class="o">:</span> <span class="l">Accept-Encoding</span>
</span><span class="line"><span class="na">Server</span><span class="o">:</span> <span class="l">tfe</span>
</span><span class="line">
</span><span class="line">oauth_token=NPcudxy0yU5T3tBzho7iCotZ3cnetKwcTIRlX0iwRl0<span class="err">&amp;</span>
</span><span class="line">oauth_token_secret=veNRnAWe6inFuo8o2u8SLLZLjolYDmDP7SzL0YfYI<span class="err">&amp;</span>
</span><span class="line">oauth_callback_confirmed=true
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>可以看到, <code>200</code> response 以及 <code>oauth_token</code>, <code>oauth_token_secret</code> 和 <code>oauth_callback_confirmed</code> 参数表示这次OAuth请求是成功的。接下来你就可以用 <code>oauth_token_secret</code> 来生成你的签名作为 <code>access token</code> 然后使用 <code>oauth_token</code>参数发送出去进行认证。</p>

<p>一般来说, <code>oauth_token</code> 发送的格式是 <code>?oauth_token=[token]</code> ，在认证的endpoint收到之后会进行一次 <code>3-Legged OAuth 1.0a</code> 并返回 <code>oauth_token</code> 和 <code>oauth_verifier</code>。返回的参数也会被用到 <code>Access Token</code> request<sup id="fnref:1"><a href="#fn:1" rel="footnote">3</a></sup>中去。</p>

<h2 id="oauth-10a-one-legged">OAuth 1.0a (one-legged)</h2>

<p>一般被叫成 <code>two-legged</code> 的OAuth其实是只有一步的。</p>

<p><img src="/downloads/images/oauth_flow_1.png" align="right" /></p>

<ol>
  <li>应用发送一个 <strong>signed</strong> request 到服务提供商，request里包括:
    <ul>
      <li><code>oauth_token</code> <em>Empty String</em></li>
      <li><code>oauth_consumer_key</code></li>
      <li><code>oauth_timestamp</code></li>
      <li><code>oauth_nonce</code></li>
      <li><code>oauth_signature</code></li>
      <li><code>oauth_signature_method</code></li>
      <li><code>oauth_version</code> <em>Optional</em></li>
    </ul>
  </li>
  <li>服务提供商验证后，提供相应的资源供应用访问。</li>
  <li>应用请求可以访问的资源。</li>
</ol>

<p>这种最简单的方式当然也是安全是漏洞最多的方式。通常如果你都已经想到要用OAuth了，就不该考虑这么简陋的方式了。</p>

<hr />

<p><strong>Note:</strong> Google 要求请求里面要带一个不是<code>oauth</code>开头的参数叫 <code>xoauth_requester_id</code><sup id="fnref:2"><a href="#fn:2" rel="footnote">4</a></sup>，这个要求在OAuth2里面过期了。</p>

<hr />

<h2 id="oauth-10a-two-legged">OAuth 1.0a (two-legged)</h2>

<p>真正的<code>two-legged</code>是1.0a版本的OAuth。</p>

<p><img src="/downloads/images/oauth_flow_2.png" align="right" /></p>

<ol>
  <li>应用发送一个 <strong>signed</strong> request到服务提供商请求一个 <code>Request Token</code>，request里包括:
    <ul>
      <li><code>oauth_consumer_key</code></li>
      <li><code>oauth_timestamp</code></li>
      <li><code>oauth_nonce</code></li>
      <li><code>oauth_signature</code></li>
      <li><code>oauth_signature_method</code></li>
      <li><code>oauth_version</code> <em>可选</em></li>
    </ul>
  </li>
  <li>服务提供商返回 <code>Request Token</code>:
    <ul>
      <li><code>oauth_token</code></li>
      <li><code>oauth_token_secret</code></li>
      <li>… 其他额外的参数</li>
    </ul>
  </li>
  <li>应用再次发送<strong>signed</strong> request来用<code>Request Token</code>换<code>Access Token</code>，请求中包括：
    <ul>
      <li><code>oauth_token</code> <em>Request Token</em></li>
      <li><code>oauth_consumer_key</code></li>
      <li><code>oauth_nonce</code></li>
      <li><code>oauth_signature</code></li>
      <li><code>oauth_signature_method</code></li>
      <li><code>oauth_version</code></li>
    </ul>
  </li>
  <li>服务提供商返回 <code>Access Token</code> 和 <code>Token Secret</code>，整个payload的参数和第二步一样主要是<code>oauth_token</code>和<code>oauth_token_secret</code>。</li>
  <li>应用使用<code>oauth_token</code> 和 <code>oauth_token_secret</code> 来访问被权限保护的资源。</li>
</ol>

<p>这里我们可以看到安全性被增强了，而应用开发者不会有太多的工作，用户更是完全觉察不到。</p>

<h2 id="oauth-10a-three-legged">OAuth 1.0a (three-legged)</h2>

<p>最完备同时也是带来最多麻烦的一个版本，特别是引入了需要用户操作来确认的部分，增加了开发和交互上的复杂度。一开始推出的时候，让很多用户感到不知所措。</p>

<p><img src="/downloads/images/oauth_flow_3.png" align="right" /></p>

<ol>
  <li>应用发送一个 <strong>signed</strong> request到服务提供商请求一个 <code>Request Token</code>，request里包括:
    <ul>
      <li><code>oauth_consumer_key</code></li>
      <li><code>oauth_timestamp</code></li>
      <li><code>oauth_nonce</code></li>
      <li><code>oauth_signature</code></li>
      <li><code>oauth_signature_method</code></li>
      <li><code>oauth_version</code> <em>Optional</em></li>
      <li><code>oauth_callback</code></li>
    </ul>
  </li>
  <li>服务提供商返回 <code>Request Token</code>:
    <ul>
      <li><code>oauth_token</code></li>
      <li><code>oauth_token_secret</code></li>
      <li><code>oauth_callback_confirmed</code></li>
      <li>… Additional Parameters / Arguments</li>
    </ul>
  </li>
  <li>返回包含下面参数的url
    <ul>
      <li><code>oauth_token</code></li>
    </ul>
  </li>
  <li>弹出窗口访问返回的url，要求用户授权</li>
  <li>用户授权</li>
  <li>返回到应用中，并保存下面的参数:
    <ul>
      <li><code>oauth_token</code></li>
      <li><code>oauth_verifier</code></li>
    </ul>
  </li>
  <li>应用发送<strong>signed</strong> request，用<code>Request Token</code> / <code>Verifier</code> 换 <code>Access Token</code>, 请求中包括：
    <ul>
      <li><code>oauth_token</code> <em>Request Token;</em></li>
      <li><code>oauth_consumer_key</code></li>
      <li><code>oauth_nonce</code></li>
      <li><code>oauth_signature</code></li>
      <li><code>oauth_signature_method</code></li>
      <li><code>oauth_version</code></li>
      <li><code>oauth_verifier</code></li>
    </ul>
  </li>
  <li>服务提供商返回 <code>Access Token</code> 和 <code>Token Secret</code>，整个payload的参数和第二步一样主要是<code>oauth_token</code>和<code>oauth_token_secret</code>。</li>
  <li>应用使用<code>oauth_token</code> 和 <code>oauth_token_secret</code> 来访问被权限保护的资源。</li>
</ol>

<hr />

<p><strong>Note:</strong> 在<em>第6步</em> 如果 <code>oauth_verifier</code> 没有被发送，那么就会认证失败。只有极少数的实现可以接受只发送<code>oauth_token</code>，这样的服务提供商被认为是不完整的实现了OAuth 1.0a 3-Legged。</p>

<hr />

<h2 id="oauth-10a-echo">OAuth 1.0a (Echo)</h2>

<p>非主流的一种实现，但是确实是存在的：发明者是Twitter的Raffi。这种实现允许在首次发送的请求token里面多带两个header，这样可以通过代理的方式在代理服务商那里对原始服务商的用户进行认证。</p>

<p><img src="/downloads/images/oauth_flow_4.png" align="right" /></p>

<ol>
  <li>应用发送一个 <strong>signed</strong> request到代理服务提供商，request里包括:
    <ul>
      <li><code>oauth_consumer_key</code></li>
      <li><code>oauth_timestamp</code></li>
      <li><code>oauth_nonce</code></li>
      <li><code>oauth_signature</code></li>
      <li><code>oauth_signature_method</code></li>
      <li><code>oauth_version</code> <em>Optional</em></li>
      <li><code>oauth_callback</code></li>
    </ul>

    <p>还包括额外的header:
 - <code>X-Auth-Service-Provider</code>
 - <code>X-Verify-Credentials-Authorization</code></p>
  </li>
  <li>代理服务商拿到额外的header信息到原始服务商认证</li>
  <li>代理服务商认证通过后，可以返回受限资源的url给应用。</li>
</ol>

<h2 id="oauth-10a-xauth">OAuth 1.0a (xAuth)</h2>

<p>xAuth是一种桌面程序或者手机程序（没有使用webview等控件不能完成完整流程的程序）使用的OAuth方式。它通过提供用户的<code>email</code>和<code>password</code>给服务器提供商来换取<code>access token</code>。 </p>

<p>这种方式返回的一般是具有只读性质的access token，并且这种token能操作的资源也是有限的。比如Twitter的DM（类似私信）就不能使用xAuth而必须用完整的<code>three-legged</code>流程获取token才能取到。</p>

<p><img src="/downloads/images/oauth_flow_5.png" align="right" /></p>

<ol>
  <li>应用请求用户的Credentials</li>
  <li>应用发送一个 <strong>signed</strong> request到服务提供商请求一个 <code>Access Token</code>，request里包括:
    <ul>
      <li><code>oauth_consumer_key</code></li>
      <li><code>oauth_timestamp</code></li>
      <li><code>oauth_nonce</code></li>
      <li><code>oauth_signature</code></li>
      <li><code>oauth_signature_method</code></li>
      <li><code>oauth_version</code> <em>Optional</em></li>
      <li><code>oauth_callback</code></li>
    </ul>

    <p>额外还包括:
 - <code>x_auth_mode</code> = <code>client_auth</code>
 - <code>x_auth_username</code>
 - <code>x_auth_password</code>
 - <code>x_auth_permission</code> <em>可选;</em><sup id="fnref:3"><a href="#fn:3" rel="footnote">5</a></sup></p>
  </li>
  <li>服务提供商验证用户的Credentials之后返回Access Token
    <ul>
      <li><code>oauth_token</code></li>
      <li><code>oauth_token_secret</code></li>
    </ul>
  </li>
  <li>应用使用<code>Access Token</code>来访问被权限保护的资源。</li>
</ol>

<h2 id="oauth-2-two-legged">OAuth 2 (two-legged)</h2>

<p>目前为止最容易解释的一种流程，也被称为 <em>Client Credentials</em> 认证流程<sup id="fnref:4"><a href="#fn:4" rel="footnote">6</a></sup>，也有一种 <em>Resource Owner Password</em> 流程属于这类。</p>

<h3 id="client-credentials">Client Credentials</h3>

<ol>
  <li>应用发送请求给服务提供商:
    <ul>
      <li><code>grant_type</code> = <code>client_credentials</code></li>
    </ul>
  </li>
</ol>

<p>如果不是用的 <code>Authorization</code> header:
  - <code>client_id</code>
  - <code>client_secret</code>
2. 应用服务商返回 <code>Access Token</code>等信息:
    - <code>access_token</code>
    - <code>expires_in</code>
    - <code>token_type</code></p>

<h3 id="resource-owner-password">Resource Owner Password</h3>

<p>基本上就是 <code>OAuth 1.0a Echo</code> 流程，但是去掉了签名等复杂的部分。</p>

<ol>
  <li>应用向resource owner（一般就是用户)请求credentials
    <ul>
      <li><code>username</code></li>
      <li><code>password</code></li>
    </ul>
  </li>
  <li>应用向服务提供商发送request，请求内容为:
    <ul>
      <li><code>grant_type</code> = <code>password</code></li>
      <li><code>username</code></li>
      <li><code>password</code></li>
    </ul>

    <p>其格式如下:</p>

    <p><code>
 grant_type=password&amp;username=my_username&amp;password=my_password
</code></p>

    <p>如果不是用的 <code>Authorization</code> header, 下面的也需要被放到request里面:
 - <code>client_id</code>
 - <code>client_secret</code></p>

    <p>整个加起来回是：</p>

    <p><code>
 grant_type=password&amp;username=my_username&amp;password=my_password&amp;client_id=random_string&amp;client_secret=random_secret
</code></p>
  </li>
  <li>应用服务商返回 <code>Access Token</code>等信息:
    <ul>
      <li><code>access_token</code></li>
      <li><code>expires_in</code></li>
      <li><code>token_type</code></li>
    </ul>
  </li>
</ol>

<h2 id="oauth-2-three-legged">OAuth 2 (three-legged)</h2>

<p>同样去掉了很多复杂的步骤。</p>

<ol>
  <li>应用把用户引导到认证页面:
    <ul>
      <li><code>client_id</code></li>
      <li><code>redirect_uri</code></li>
      <li><code>response_type</code><sup id="fnref:5"><a href="#fn:5" rel="footnote">7</a></sup></li>
      <li><code>state</code> <em>可选;</em> 防止CSRF<sup id="fnref:6"><a href="#fn:6" rel="footnote">8</a></sup></li>
      <li><code>scope</code> <em>可选;</em> 你可以获取的资源范围</li>
    </ul>

    <p>一个例子（为了可读性没有进行Encode）:</p>

    <p><code>
https://oauth_service/login/oauth/authorize?client_id=3MVG9lKcPoNINVB&amp;redirect_uri=http://localhost/oauth/code_callback&amp;scope=user
</code></p>
  </li>
  <li>用户登录到服务中，批准应用申请权限。</li>
  <li>服务提供商把用户重定向到 <code>redirect_url</code> 并带上:
    <ul>
      <li><code>code</code></li>
      <li><code>state</code></li>
    </ul>
  </li>
  <li>应用使用 <code>code</code> 用来请求 <code>Access Token</code>:
    <ul>
      <li><code>client_id</code></li>
      <li><code>client_secret</code></li>
      <li><code>code</code></li>
      <li><code>redirect_uri</code> <em>可选;</em><sup id="fnref:7"><a href="#fn:7" rel="footnote">9</a></sup></li>
      <li><code>grant_type</code> = <code>"authorization_code"</code> [^7]</li>
    </ul>
  </li>
  <li>如果 <code>client_id</code> 和 <code>client_secret</code> 正确，服务提供商调用回调到 <code>redirect_url</code> 返回 <code>access_token</code>等信息:
    <ul>
      <li><code>access_token</code></li>
      <li><code>expires_in</code></li>
      <li><code>refresh_token</code></li>
    </ul>
  </li>
  <li>应用保存 <code>access_token</code> 并使用。
    <ul>
      <li>一般来说保存到session或者是cookie里，然后放在 <code>Authorization: [Bearer] access_token</code> header里面用，其中<code>[Bearer]</code>是 <code>Header Authorization Bearer Name</code>，如<code>Bearer</code>, <code>OAuth</code>, <code>MAC</code>等。</li>
    </ul>
  </li>
</ol>

<hr />

<p><strong>有趣的事实:</strong> 有些RFC里面的规定，比如scope的分隔符用空格等，根本没有人遵守。所以开发者根本不知道API会在下个版本变成什么样子。</p>

<hr />

<h2 id="oauth-2-refresh-token">OAuth 2 (refresh token)</h2>

<p>在OAuth2中，<code>access_token</code>一般是有有效期的。一个过期的token被使用时，服务器会返回一个token过期的错误，并带上<code>refresh_token</code>。应用使用<code>refresh token</code>获取新的<code>access_token</code>会比前面描述的流程简单得多。</p>

<ol>
  <li>发送请求到服务提供商的<code>Refresh Token URI</code>:
    <ul>
      <li><code>grant_type</code> = <code>"refresh_token"</code></li>
      <li><code>scope</code> <em>可选;</em> 更新时不能指定之前没有的scope</li>
      <li><code>refresh_token</code></li>
      <li><code>client_id</code></li>
      <li><code>client_secret</code></li>
    </ul>
  </li>
  <li>服务提供商验证参数后返回:
    <ul>
      <li><code>access_token</code></li>
      <li><code>issued_at</code></li>
    </ul>
  </li>
</ol>

<h2 id="tips--tricks">Tips &amp; Tricks</h2>

<h3 id="access-tokenrefresh-key">生成Access Token和Refresh Key</h3>

<p>最好使用uuid，也就是固定长度的随机字符组成的字符串。</p>

<h4 id="section">例子</h4>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="kd">var</span> <span class="nx">OAuth</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mashape-oauth&#39;</span><span class="p">).</span><span class="nx">OAuth</span><span class="p">,</span>
</span><span class="line">    <span class="nx">access_token</span> <span class="o">=</span> <span class="nx">OAuth</span><span class="p">.</span><span class="nx">nonce</span><span class="p">(</span><span class="cm">/* Length, Default 32 */</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="references">References</h2>

<ol>
  <li><a href="http://www.flickr.com/services/api/auth.oauth.html">Authorizing with OAuth</a> - Flickr Documentation</li>
  <li><a href="https://confluence.atlassian.com/display/BITBUCKET/OAuth+on+Bitbucket">OAuth on Bitbucket</a> - Bitbucket Documentation</li>
  <li><a href="https://dev.twitter.com/docs/auth/oauth">OAuth Documentation</a> - Twitter Documentation</li>
  <li><a href="http://2.bp.blogspot.com/-Va1Rp3-r898/TZiVh9xEJDI/AAAAAAAAAMw/8ImBIW_dXuY/s1600/OAuth-legs.png">OAuth Extended Flows</a></li>
  <li><a href="https://code.google.com/p/oauth-php/wiki/ConsumerHowTo#Two-legged_OAuth">2-Legged OAuth</a> - OAuth-PHP</li>
  <li><a href="http://oauth.googlecode.com/svn/spec/ext/consumer_request/1.0/drafts/2/spec.html">OAuth for Consumer Requests</a></li>
  <li><a href="http://term.ie/oauth/example/">OAuth Example</a> - term.ie</li>
  <li><a href="http://hueniverse.com/oauth/guide/">OAuth 1.0 Guide</a> - Heuniverse</li>
  <li><a href="http://oauth.net/core/diagram.png">OAuth 1.0a Diagram</a></li>
  <li><a href="http://wiki.oauth.net">OAuth Wiki</a></li>
  <li><a href="http://architects.dzone.com/articles/2-legged-oauth-oauth-10-and-20">2-Legged OAuth 1.0 &amp; 2.0</a> - DZone</li>
  <li><a href="https://developers.google.com/accounts/docs/OAuth">OAuth</a> &amp; <a href="https://developers.google.com/accounts/docs/OAuth2">OAuth2</a> - Google Documentation</li>
  <li><a href="http://blog.nerdbank.net/2011/06/what-is-2-legged-oauth.html">What is 2-legged OAuth?</a> - Nerdbank</li>
  <li><a href="http://en.wikipedia.org/wiki/OAuth#List_of_OAuth_service_providers">List of Service Providers</a> - Wikipedia</li>
  <li><a href="http://developers.mobypicture.com/documentation/authentication/oauth-echo/">OAuth Echo</a> - mobypicture</li>
  <li><a href="https://dev.twitter.com/docs/auth/oauth/oauth-echo">OAuth Echo</a> - Twitter</li>
  <li><a href="http://developer.vimeo.com/apis/advanced">Advanced API</a> - Vimeo Developer();</li>
  <li><a href="https://dev.twitter.com/docs/oauth/xauth">About xAuth</a> - Twitter xAuth Documentation</li>
  <li><a href="https://dev.twitter.com/docs/auth/implementing-sign-twitter">Implementing Sign-in</a> - Twitter Sign-in Documentation</li>
  <li><a href="http://tools.ietf.org/html/rfc6749">RFC6749</a> - IETF</li>
  <li><a href="http://developer.github.com/v3/oauth/">Web Application Flow</a> - Github OAuth2</li>
  <li><a href="http://www.salesforce.com/us/developer/docs/api_rest/Content/quickstart_oauth.htm">OAuth2 Quickstart</a> - Salesforce</li>
  <li><a href="https://developers.geoloqi.com/api/authentication">Authentication Mechanisms</a> - Geoloqi</li>
  <li><a href="http://www.salesforce.com/us/developer/docs/api_rest/Content/intro_understanding_web_server_oauth_flow.htm">Understanding Web Server OAuth Flow</a> - Salesforce</li>
  <li><a href="http://blog.springsource.org/2011/11/30/10317/">CSRF &amp; OAuth2</a> - Springsource</li>
  <li><a href="https://tools.ietf.org/html/draft-ietf-oauth-v2-31">OAuth v2-31</a> - IETF</li>
  <li><a href="http://techblog.hybris.com/2012/06/11/oauth2-resource-owner-password-flow/">Resource Owner Flow</a> - Hybris</li>
</ol>

<div class="footnotes">
  <ol>
    <li id="fn:8">
      <p><a href="http://en.wikipedia.org/wiki/Hash-based_message_authentication_code">Hash based message authentication code</a>.<a href="#fnref:8" rel="reference">&#8617;</a></p>
    </li>
    <li id="fn:9">
      <p><a href="http://en.wikipedia.org/wiki/RSA_(algorithm\)">RSA Algorithm</a>.<a href="#fnref:9" rel="reference">&#8617;</a></p>
    </li>
    <li id="fn:1">
      <p><a href="https://dev.twitter.com/docs/auth/implementing-sign-twitter">Implementing sign twitter</a>.<a href="#fnref:1" rel="reference">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p><a href="https://developers.google.com/google-apps/gmail/oauth_protocol#oauth_request_url">Oauth request url</a>.<a href="#fnref:2" rel="reference">&#8617;</a></p>
    </li>
    <li id="fn:3">
      <p><a href="http://developer.vimeo.com/apis/advanced">Vimeo API Advanced</a><a href="#fnref:3" rel="reference">&#8617;</a></p>
    </li>
    <li id="fn:4">
      <p><a href="https://tools.ietf.org/html/draft-ietf-oauth-v2-31#section-4.4">IETF OATUH V2 Section 4.4</a>.<a href="#fnref:4" rel="reference">&#8617;</a></p>
    </li>
    <li id="fn:5">
      <p><a href="http://tools.ietf.org/html/draft-ietf-oauth-v2-31#section-4.1.1">IETF OATUH V2 Section 4.1.1</a>.<a href="#fnref:5" rel="reference">&#8617;</a></p>
    </li>
    <li id="fn:6">
      <p><a href="http://blog.springsource.org/2011/11/30/10317/">CROSS SITE REQUEST FORGERY AND OAUTH2</a>.<a href="#fnref:6" rel="reference">&#8617;</a></p>
    </li>
    <li id="fn:7">
      <p><a href="http://tools.ietf.org/html/rfc6749#section-4.1.3">RFC6749</a>.<a href="#fnref:7" rel="reference">&#8617;</a></p>
    </li>
  </ol>
</div>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/4/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/2/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    
  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Lenciel Li<span class="theme-version">Octopress-Lenciel 0.1</span>
  <section class="contruction-wrap">
    <div class="contruction"></div>
  </section>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'lencielgithub';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



<!--














                                            IIIIIIIIII       I
                  II                     IIIIIIIIIIIIIIIIIIII
                  IIII                  IIIIIIIIIIIIIIIIIIII
                  IIIIII                IIIIIIIIIIIIIIIIII III
                  IIIIIIII             IIIIIIIIIIIIIIIIIIIIII
                  IIIIIIIIIII          IIIIIIIIIIIIIIIIIIIII
                  IIIIIIIIIIIIII       IIIIIIIIIIIIIIIIIII
                   IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                  I  IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                  IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                  IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                   IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                    IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                     IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                         IIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                     IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                      IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                        IIIIIIIIIIIIIIIIIIIIIIIIIIIII
                           IIIIIIIIIIIIIIIIIIIIIIIII
                             IIIIIIIIIIIIIIIIIIIII
                          IIIIIIIIIIIIIIIIIIIIIII
                I   IIIIIIIIIIIIIIIIIIIIIIIIII
                  IIIIIIIIIIIIIIIIIIIIIIIIII
                      IIIIIIIIIIIIIIIIII















 -->


</body>
</html>
